<!DOCTYPE html>
<html lang="en" class="dark">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>BTC Pro Order Flow</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ðŸ“Š</text></svg>">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/golden-layout@2.6.0/dist/css/goldenlayout-base.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/golden-layout@2.6.0/dist/css/themes/goldenlayout-dark-theme.css">
<script>
tailwind.config={darkMode:'class',theme:{extend:{fontFamily:{sans:['Inter','sans-serif'],mono:['JetBrains Mono','monospace']},colors:{trade:{bg:'#0a0e1a',panel:'#0f1419',border:'#1a1f2e',accent:'#3b82f6',up:'#608feb',down:'#ff4242',text:'#8b92a7',textLight:'#e8eaed',surface:'#12161f',pocGold:'#f0b90b'}}}}}
</script>
<style>
:root{
  --bg:#0a0e1a;--panel:#0f1419;--border:#1a1f2e;--accent:#3b82f6;
  --up:#608feb;--dn:#ff4242;--tx:#8b92a7;--txl:#e8eaed;
  --sur:#12161f;--gold:#f0b90b;--mute:#5a6178;
  --fm:'JetBrains Mono',monospace
}
#layouts-dropdown.open{display:block!important;opacity:1;transform:scaleY(1)}
#layouts-dropdown{transform-origin:top}
body{background:var(--bg);overflow:hidden;user-select:none;color:var(--tx);margin:0}
.custom-scroll::-webkit-scrollbar{width:6px}
.custom-scroll::-webkit-scrollbar-track{background:transparent}
.custom-scroll::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
.custom-scroll::-webkit-scrollbar-thumb:hover{background:#2a2f3e}
#charts-container{position:absolute;top:48px;left:0;right:0;bottom:0;overflow:hidden}
.chart-panel-wrapper{position:relative;display:flex;flex-direction:column;width:100%;height:100%;overflow:hidden}
.chart-panel-wrapper.selected{box-shadow:inset 0 0 0 2px rgba(59,130,246,.4)}
.panel-tf-bar{position:absolute;top:6px;left:6px;z-index:200;display:flex;gap:3px;opacity:0;pointer-events:none;transition:opacity .2s;background:rgba(10,14,26,.88);border:1px solid var(--border);border-radius:5px;padding:3px 4px;backdrop-filter:blur(4px)}
.chart-panel-wrapper:hover .panel-tf-bar{opacity:1;pointer-events:all}
.lm_header{background:var(--panel)!important;border-bottom:1px solid var(--border)}
.lm_tab{background:var(--sur)!important;color:var(--tx)!important;border:1px solid transparent;font-family:var(--fm);font-size:11px}
.lm_tab.lm_active{background:var(--bg)!important;color:var(--txl)!important;border-top:2px solid var(--accent)!important}
.lm_splitter{background:var(--border)!important}
.lm_splitter:hover{background:rgba(59,130,246,.2)!important}
.lm_content{background:var(--bg)!important}
.indicator-pane{position:absolute;left:0;right:54px;background:rgba(10,14,26,.98);border-top:1px solid var(--border);z-index:30;transition:bottom .2s ease;pointer-events:none}
.indicator-pane.dragging{z-index:100;box-shadow:0 4px 20px rgba(59,130,246,.3);border:1px solid var(--accent)}
.pane-canvas{display:block;width:100%;height:100%;pointer-events:none}
.pane-header{position:absolute;top:0;left:0;right:0;height:20px;display:flex;align-items:center;justify-content:space-between;padding:0 8px;background:transparent;cursor:move;z-index:100;pointer-events:auto}
.pane-header:hover{background:rgba(10,14,26,.8);backdrop-filter:blur(4px)}
.pane-header:hover .pane-label{color:#a6afd3}
.pane-header:hover .pane-close{color:var(--tx)}
.pane-label{font-size:9px;text-transform:uppercase;letter-spacing:.05em;color:rgba(139,146,167,.5);font-family:var(--fm);font-weight:600;transition:color .2s}
.pane-close{width:14px;height:14px;display:flex;align-items:center;justify-content:center;border-radius:2px;font-size:11px;color:rgba(139,146,167,.5);cursor:pointer;transition:all .2s}
.pane-close:hover{background:rgba(255,66,66,.2);color:var(--dn)}
.resizer-handle{position:absolute;top:-5px;left:0;right:0;height:10px;cursor:ns-resize;z-index:50;display:flex;align-items:center;justify-content:center;pointer-events:auto}
.resizer-line{width:0;height:0;background:transparent}
input[type=range]{-webkit-appearance:none;width:100%;background:transparent}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;height:14px;width:14px;border-radius:50%;background:var(--txl);border:2px solid var(--accent);cursor:pointer;margin-top:-5px}
input[type=range]::-webkit-slider-runnable-track{width:100%;height:4px;cursor:pointer;background:var(--border);border-radius:2px}
select,input[type=number],input[type=text]{appearance:none;background:var(--panel);border:1px solid var(--border);color:var(--txl);font-family:var(--fm);font-size:12px;border-radius:4px;transition:all .2s}
select:focus,input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 1px var(--accent)}
.select-wrapper{position:relative}
.select-wrapper::after{content:'â–¼';font-size:8px;color:var(--mute);position:absolute;right:10px;top:50%;transform:translateY(-50%);pointer-events:none}
.color-picker-wrapper{position:relative;height:28px;width:100%;border-radius:4px;overflow:hidden;border:1px solid var(--border);cursor:pointer;transition:all .2s}
.color-picker-wrapper:hover{border-color:var(--accent);box-shadow:0 0 0 1px var(--accent)}
input[type=color]{border:none;width:200%;height:200%;transform:translate(-25%,-25%);cursor:pointer;background:none}
.timeframe-btn{padding:4px 10px;background:transparent;border:1px solid var(--border);color:var(--tx);font-size:11px;font-family:var(--fm);border-radius:4px;cursor:pointer;transition:all .2s}
.timeframe-btn:hover{background:var(--border);color:var(--txl)}
.timeframe-btn.active{background:var(--accent);border-color:var(--accent);color:#fff;font-weight:600}
.timeframe-btn-plus{padding:4px 8px;background:transparent;border:1px solid var(--border);color:var(--tx);font-size:14px;font-family:var(--fm);border-radius:4px;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center}
.timeframe-btn-plus:hover{background:var(--border);color:var(--accent);border-color:var(--accent);transform:rotate(90deg)}
#custom-price-label{position:absolute;right:0;z-index:40;pointer-events:none;display:flex;align-items:center;gap:1px}
.price-label-box{border-radius:4px;padding:5px 10px;font-weight:600;display:flex;flex-direction:column;align-items:flex-end;min-width:68px;gap:2px;box-shadow:0 2px 8px rgba(0,0,0,.4)}
.price-label-box::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(180deg,rgba(255,255,255,.1) 0%,transparent 100%);border-radius:3px;pointer-events:none}
.price-label-arrow{display:none!important}
.indicator-toggle{display:flex;align-items:center;gap:8px;padding:6px 12px;background:transparent;border:1px solid var(--border);border-radius:4px;cursor:pointer;transition:all .2s;font-size:11px;font-family:var(--fm);color:var(--tx)}
.indicator-toggle:hover{background:var(--border);color:var(--txl)}
.indicator-toggle.active{background:rgba(59,130,246,.1);border-color:var(--accent);color:var(--accent)}
.indicator-checkbox{width:14px;height:14px;border:2px solid var(--border);border-radius:3px;display:flex;align-items:center;justify-content:center;transition:all .2s;position:relative;flex-shrink:0}
.indicator-toggle.active .indicator-checkbox{background:var(--accent);border-color:var(--accent)}
.indicator-checkbox::after{content:'';position:absolute;width:6px;height:3.5px;border-left:1.5px solid #fff;border-bottom:1.5px solid #fff;transform:rotate(-45deg);left:50%;top:50%;margin-left:-3px;margin-top:-2.5px;opacity:0;transition:opacity .2s}
.indicator-toggle.active .indicator-checkbox::after{opacity:1}
.drag-placeholder{position:absolute;left:0;right:77px;height:2px;background:var(--accent);z-index:150;box-shadow:0 0 10px rgba(59,130,246,.5)}
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);z-index:9999;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .3s ease;pointer-events:none}
.modal-overlay.active{opacity:1;pointer-events:all}
.modal-content{background:linear-gradient(135deg,#0d1117 0%,var(--panel) 100%);border:1px solid var(--border);border-radius:12px;padding:32px;min-width:400px;box-shadow:0 20px 60px rgba(0,0,0,.5);transform:scale(.9);transition:transform .3s cubic-bezier(.4,0,.2,1)}
.modal-overlay.active .modal-content{transform:scale(1)}
.modal-title{font-family:var(--fm);font-size:18px;font-weight:600;color:var(--txl);margin-bottom:8px;text-transform:uppercase;letter-spacing:.05em}
.modal-description{font-size:13px;color:var(--tx);margin-bottom:24px;line-height:1.5}
.modal-input{width:100%;padding:12px 16px;background:var(--bg);border:2px solid var(--border);border-radius:8px;color:var(--txl);font-family:var(--fm);font-size:16px;transition:all .2s;margin-bottom:24px}
.modal-buttons{display:flex;gap:12px;justify-content:flex-end}
.modal-btn{padding:10px 24px;border-radius:6px;font-family:var(--fm);font-size:12px;font-weight:600;cursor:pointer;transition:all .2s;text-transform:uppercase;letter-spacing:.05em}
.modal-btn-cancel{background:transparent;border:1px solid var(--border);color:var(--tx)}
.modal-btn-cancel:hover{background:var(--border);color:var(--txl)}
.modal-btn-confirm{background:var(--accent);border:1px solid var(--accent);color:#fff}
.modal-btn-confirm:hover{background:#2563eb;border-color:#2563eb;transform:translateY(-1px);box-shadow:0 4px 12px rgba(59,130,246,.3)}
#settings-panel{background:linear-gradient(135deg,#0d1117 0%,var(--panel) 100%)}
.settings-section{border-bottom:1px solid rgba(26,31,46,.5);transition:all .3s cubic-bezier(.4,0,.2,1)}
.settings-section:last-child{border-bottom:none}
.section-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;cursor:pointer;transition:all .2s;background:transparent;position:relative;overflow:hidden}
.section-header::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--accent);transform:scaleY(0);transition:transform .3s ease}
.section-header:hover{background:rgba(59,130,246,.05)}
.section-header:hover::before{transform:scaleY(1)}
.section-header::after{content:'â–¾';font-size:15px;color:var(--mute);transition:all .3s cubic-bezier(.4,0,.2,1);line-height:1}
.settings-section.expanded .section-header::after{transform:rotate(180deg);color:var(--accent)}
.section-title-wrapper{display:flex;align-items:center;gap:12px}
.section-icon{width:20px;height:20px;display:flex;align-items:center;justify-content:center;color:var(--accent);opacity:.8;transition:all .3s ease}
.section-header:hover .section-icon{opacity:1;transform:scale(1.1)}
.section-title{font-family:var(--fm);font-size:13px;font-weight:600;color:var(--txl);text-transform:uppercase;letter-spacing:.05em}
.section-content{max-height:0;overflow:hidden;transition:max-height .4s cubic-bezier(.4,0,.2,1)}
.settings-section.expanded .section-content{max-height:2000px}
.section-body{padding:0 20px 20px;display:grid;gap:16px}
.setting-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.setting-item{display:flex;flex-direction:column;gap:6px}
.setting-item.full-width{grid-column:1/-1}
.setting-label{font-size:11px;font-weight:500;color:#a6afd3;text-transform:uppercase;letter-spacing:.05em;font-family:var(--fm)}
.setting-description{font-size:10px;color:var(--mute);margin-top:-2px;font-family:'Inter',sans-serif}
.slider-container{display:flex;flex-direction:column;gap:8px}
.slider-header{display:flex;justify-content:space-between;align-items:center}
.slider-value{font-family:var(--fm);font-size:11px;font-weight:600;color:var(--accent);background:rgba(59,130,246,.1);padding:2px 8px;border-radius:3px;min-width:50px;text-align:center}
.setting-divider{height:1px;background:linear-gradient(90deg,transparent 0%,rgba(26,31,46,.5) 50%,transparent 100%);margin:8px 0}
.toggle-switch{position:relative;width:44px;height:24px;background:var(--border);border-radius:12px;cursor:pointer;transition:all .3s ease;border:1px solid var(--border)}
.toggle-switch.active{background:var(--accent);border-color:var(--accent)}
.toggle-switch::after{content:'';position:absolute;top:2px;left:2px;width:18px;height:18px;background:#fff;border-radius:50%;transition:all .3s cubic-bezier(.4,0,.2,1);box-shadow:0 2px 4px rgba(0,0,0,.2)}
.toggle-switch.active::after{transform:translateX(20px)}
.reset-button{padding:8px 16px;background:rgba(255,66,66,.1);border:1px solid rgba(255,66,66,.3);color:var(--dn);border-radius:4px;font-family:var(--fm);font-size:11px;font-weight:600;cursor:pointer;transition:all .2s;text-transform:uppercase;letter-spacing:.05em}
.reset-button:hover{background:rgba(255,66,66,.2);border-color:var(--dn);transform:translateY(-1px);box-shadow:0 4px 8px rgba(255,66,66,.2)}
.tpo-legend{display:inline-flex;align-items:center;gap:5px;font-family:var(--fm);font-size:10px;padding:3px 8px;border-radius:3px;border:1px solid rgba(255,255,255,.08)}
.tpo-swatch{width:10px;height:10px;border-radius:2px;flex-shrink:0}
.icon-svg{fill:none;stroke:currentColor;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
</style>
</head>
<body class="font-sans text-trade-text antialiased h-screen flex flex-col">

<header class="h-[48px] bg-trade-panel/90 backdrop-blur-md border-b border-trade-border flex items-center justify-between px-4 shrink-0 z-50 relative">
  <div class="flex items-center gap-6 font-mono">
    <div class="flex items-center gap-2.5">
      <div class="relative flex h-2 w-2">
        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
        <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
      </div>
      <div class="flex flex-col leading-none">
        <span class="text-white font-bold tracking-wider text-sm">BTCUSD</span>
        <span class="text-[10px] text-gray-500 font-sans">Perpetual</span>
      </div>
      <div class="flex gap-1 ml-2">
        <button class="timeframe-btn" data-tf="1">1m</button>
        <button class="timeframe-btn" data-tf="3">3m</button>
        <button class="timeframe-btn active" data-tf="5">5m</button>
        <button class="timeframe-btn" data-tf="15">15m</button>
        <button class="timeframe-btn" data-tf="30">30m</button>
        <button class="timeframe-btn" data-tf="60">1h</button>
        <button class="timeframe-btn" data-tf="240">4h</button>
        <button class="timeframe-btn" data-tf="D">1D</button>
        <button class="timeframe-btn-plus" id="custom-tf-btn">+</button>
      </div>
    </div>
    <div class="h-6 w-px bg-trade-border/50"></div>
    <div class="flex items-baseline gap-1.5">
      <span id="price" class="text-[#f0b90b] text-lg font-bold tracking-tight">0.00</span>
      <span class="text-[10px] text-gray-500">USD</span>
    </div>
    <div class="h-6 w-px bg-trade-border/50"></div>
    <div class="flex items-center gap-4">
      <div class="flex flex-col items-start leading-none gap-0.5">
        <span class="text-[9px] text-gray-500 uppercase tracking-wider font-sans">Tick Size</span>
        <span id="tick-display" class="text-xs font-medium text-gray-300">5</span>
      </div>
      <div class="flex flex-col items-start leading-none gap-0.5">
        <span class="text-[9px] text-gray-500 uppercase tracking-wider font-sans">Open Interest</span>
        <span id="oi-display" class="text-xs text-blue-400 font-medium font-mono">Loading...</span>
      </div>
    </div>
  </div>
  <div class="flex items-center gap-3">
    <div class="flex items-center gap-2">
      <span class="text-[10px] text-gray-500 uppercase tracking-wider">Indicators:</span>
      <button id="toggle-oi" class="indicator-toggle active"><div class="indicator-checkbox"></div><span>OI</span></button>
      <button id="toggle-cvd" class="indicator-toggle"><div class="indicator-checkbox"></div><span>CVD</span></button>
      <button id="toggle-barstats" class="indicator-toggle"><div class="indicator-checkbox"></div><span>Bar Stats</span></button>
      <button id="toggle-tpo" class="indicator-toggle"><div class="indicator-checkbox"></div><span>TPO</span></button>
      <button id="toggle-vwap" class="indicator-toggle"><div class="indicator-checkbox"></div><span>VWAP</span></button>
      <button id="toggle-dailylevels" class="indicator-toggle"><div class="indicator-checkbox"></div><span>Levels</span></button>
    </div>
    <div class="h-6 w-px bg-trade-border/50"></div>
    <div class="relative" id="layouts-wrapper">
      <button id="layouts-btn" class="px-3 py-1.5 text-[11px] font-mono font-semibold bg-transparent border border-trade-border hover:border-blue-500 text-gray-400 hover:text-blue-400 rounded-md transition-all active:scale-95">Layouts</button>
      <div id="layouts-dropdown" class="hidden absolute right-0 top-[calc(100%+6px)] w-56 bg-[#12161f] border border-trade-border rounded-lg shadow-2xl py-1.5 z-[5000] backdrop-blur-sm origin-top scale-y-95 opacity-0 transition-all duration-200">
        <div class="px-4 py-2 text-[11px] font-mono font-semibold text-gray-400 uppercase tracking-wider">Layouts</div>
        <div id="save-layout-btn" class="menu-item px-4 py-2.5 hover:bg-blue-600/10 hover:text-blue-400 cursor-pointer flex items-center gap-2 text-gray-300 transition-colors">
          <svg class="icon-svg w-3 h-3" viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
          <span class="font-medium text-[11px]">Save Current Layout</span>
        </div>
        <div class="h-px bg-trade-border mx-2 my-1"></div>
        <div id="saved-layouts-list" class="max-h-48 overflow-y-auto custom-scroll">
          <div class="px-4 py-2 text-[10px] text-gray-600 font-mono italic">No saved layouts yet</div>
        </div>
      </div>
    </div>
    <button id="add-chart-btn" class="px-3 py-1.5 text-[11px] font-mono font-semibold bg-transparent border border-trade-border hover:border-blue-500 text-gray-400 hover:text-blue-400 rounded-md transition-all active:scale-95">+ Chart</button>
    <div class="h-6 w-px bg-trade-border/50"></div>
    <button id="header-settings-btn" class="p-2 hover:bg-[#1a1f2e] rounded-md text-gray-400 hover:text-white transition-all active:scale-95 group">
      <svg class="icon-svg w-[18px] h-[18px] group-hover:rotate-45 transition-transform duration-300" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
    </button>
  </div>
</header>

<div id="charts-container"></div>

<div id="indicator-ctx-menu" style="display:none;position:fixed;z-index:10000;width:252px;background:linear-gradient(135deg,#0d1117 0%,var(--panel) 100%);border:1px solid var(--border);border-radius:10px;box-shadow:0 12px 40px rgba(0,0,0,.65);overflow:hidden;font-family:var(--fm);">
  <div style="display:flex;align-items:center;justify-content:space-between;padding:9px 14px;border-bottom:1px solid var(--border);background:linear-gradient(90deg,rgba(59,130,246,.09) 0%,transparent 100%);">
    <span id="ind-ctx-title" style="font-size:11px;font-weight:600;color:var(--txl);text-transform:uppercase;letter-spacing:.06em;"></span>
    <button id="ind-ctx-close" style="background:none;border:none;color:var(--mute);cursor:pointer;font-size:13px;padding:1px 4px;border-radius:3px;line-height:1;transition:color .15s;" onmouseover="this.style.color='#ff4242'" onmouseout="this.style.color=getComputedStyle(document.documentElement).getPropertyValue('--mute')">âœ•</button>
  </div>
  <div id="ind-ctx-body" style="padding:10px 14px;display:grid;gap:8px;"></div>
</div>

<div id="custom-tf-modal" class="modal-overlay">
  <div class="modal-content">
    <h2 class="modal-title">Custom Timeframe</h2>
    <p class="modal-description">Enter a timeframe: Numbers for minutes (e.g., "15", "45")<br>Add suffix for periods: "d" = days, "w" = weeks, "M" = months</p>
    <input type="text" id="custom-tf-input" class="modal-input" placeholder="e.g., 15, 1h, 1d, 1w" autocomplete="off">
    <div class="modal-buttons">
      <button class="modal-btn modal-btn-cancel" id="custom-tf-cancel">Cancel</button>
      <button class="modal-btn modal-btn-confirm" id="custom-tf-confirm">Apply</button>
    </div>
  </div>
</div>

<div id="settings-panel" class="absolute top-[49px] left-0 bottom-0 w-96 backdrop-blur-xl border-r border-trade-border z-[1000] transform -translate-x-full transition-transform duration-300 ease-out shadow-2xl flex flex-col">
  <div class="flex items-center justify-between p-5 border-b border-trade-border/50 bg-gradient-to-r from-blue-600/10 to-transparent">
    <div class="flex items-center gap-3">
      <div class="w-8 h-8 rounded-lg bg-blue-600/20 flex items-center justify-center">
        <svg class="icon-svg w-4 h-4 text-blue-400" viewBox="0 0 24 24"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
      </div>
      <h2 class="text-white font-semibold text-base">Chart Settings</h2>
    </div>
    <button id="close-settings" class="text-gray-500 hover:text-white transition p-2 rounded-lg hover:bg-white/10 active:scale-95">
      <svg class="icon-svg w-[18px] h-[18px]" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
  </div>

  <div class="flex-1 overflow-y-auto custom-scroll">

    <!-- Chart Appearance -->
    <div class="settings-section">
      <div class="section-header" onclick="toggleSection(this)">
        <div class="section-title-wrapper">
          <div class="section-icon"><svg class="icon-svg w-5 h-5" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg></div>
          <span class="section-title">Chart Appearance</span>
        </div>
      </div>
      <div class="section-content"><div class="section-body">
        <div class="setting-row">
          <div class="setting-item">
            <label class="setting-label">Chart Type</label>
            <div class="select-wrapper"><select id="series-type-select" class="w-full px-3 py-2"><option value="candle" selected>Candles</option><option value="bar">Bars</option></select></div>
          </div>
          <div class="setting-item">
            <label class="setting-label">Bar Spacing</label>
            <input type="number" id="bar-spacing-input" value="50" min="10" max="200" step="5" class="w-full px-3 py-2">
          </div>
        </div>
        <div class="setting-item">
          <div class="slider-container">
            <div class="slider-header"><label class="setting-label">Candle Opacity</label><span id="opacity-val" class="slider-value">100%</span></div>
            <input type="range" id="candle-opacity" min="0" max="100" value="100" step="5">
          </div>
        </div>
        <div class="setting-divider"></div>
        <div class="setting-row">
          <div class="setting-item">
            <label class="setting-label">Candle Width %</label>
            <input type="number" id="candle-width-input" value="20" min="5" max="80" step="5" class="w-full px-3 py-2">
          </div>
          <div class="setting-item">
            <label class="setting-label">Cluster Width %</label>
            <input type="number" id="cluster-width-input" value="80" min="20" max="95" step="5" class="w-full px-3 py-2">
          </div>
        </div>
        <div class="setting-item">
          <div class="slider-container">
            <div class="slider-header"><label class="setting-label">Wick Thickness</label><span id="wick-thickness-val" class="slider-value">1px</span></div>
            <input type="range" id="wick-thickness" min="1" max="5" value="1" step="0.5">
          </div>
        </div>
        <div class="setting-item">
          <div class="slider-container">
            <div class="slider-header"><label class="setting-label">Border Thickness</label><span id="border-thickness-val" class="slider-value">1px</span></div>
            <input type="range" id="border-thickness" min="0" max="5" value="1" step="0.5">
          </div>
        </div>
        <div class="setting-divider"></div>
        <div class="setting-row">
          <div class="setting-item">
            <label class="setting-label">Price Scale Font</label>
            <input type="number" id="price-scale-font-input" value="10" min="8" max="16" step="1" class="w-full px-3 py-2">
          </div>
        </div>
      </div></div>
    </div>

    <!-- Colors & Theme -->
    <div class="settings-section">
      <div class="section-header" onclick="toggleSection(this)">
        <div class="section-title-wrapper">
          <div class="section-icon"><svg class="icon-svg w-5 h-5" viewBox="0 0 24 24"><circle cx="13.5" cy="6.5" r=".5"/><circle cx="17.5" cy="10.5" r=".5"/><circle cx="8.5" cy="7.5" r=".5"/><circle cx="6.5" cy="12.5" r=".5"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/></svg></div>
          <span class="section-title">Colors &amp; Theme</span>
        </div>
      </div>
      <div class="section-content"><div class="section-body">
        <div class="setting-row">
          <div class="setting-item"><label class="setting-label">Bullish Color</label><div class="color-picker-wrapper"><input type="color" id="up-candle-color" value="#608feb"></div></div>
          <div class="setting-item"><label class="setting-label">Bearish Color</label><div class="color-picker-wrapper"><input type="color" id="down-candle-color" value="#ff4242"></div></div>
        </div>
        <div class="setting-divider"></div>
        <div class="setting-item"><label class="setting-label">Grid Lines</label><div class="color-picker-wrapper"><input type="color" id="grid-color-input" value="#636363"></div></div>
        <div class="setting-item"><label class="setting-label">POC Highlight</label><div class="color-picker-wrapper"><input type="color" id="poc-color-input" value="#f0b90b"></div></div>
        <div class="setting-divider"></div>
        <div class="setting-row">
          <div class="setting-item"><label class="setting-label">Background</label><div class="color-picker-wrapper"><input type="color" id="bg-color-input" value="#0a0e1a"></div></div>
          <div class="setting-item"><label class="setting-label">Panel Color</label><div class="color-picker-wrapper"><input type="color" id="panel-color-input" value="#0f1419"></div></div>
        </div>
        <div class="setting-item"><label class="setting-label">Accent Color</label><div class="color-picker-wrapper"><input type="color" id="accent-color-input" value="#3b82f6"></div></div>
        <div class="setting-item"><label class="setting-label">Absorption Dot Color</label><div class="color-picker-wrapper"><input type="color" id="absorption-color-input" value="#FFD700"></div></div>
      </div></div>
    </div>

    <!-- Grid & Scale -->
    <div class="settings-section">
      <div class="section-header" onclick="toggleSection(this)">
        <div class="section-title-wrapper">
          <div class="section-icon"><svg class="icon-svg w-5 h-5" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M3 15h18M9 3v18M15 3v18"/></svg></div>
          <span class="section-title">Grid &amp; Scale</span>
        </div>
      </div>
      <div class="section-content"><div class="section-body">
        <div class="setting-item">
          <label class="setting-label">Grid Spacing ($)</label>
          <input type="number" id="grid-spacing-input" value="1000" step="100" min="100" max="10000" class="w-full px-3 py-2">
          <span class="setting-description">Price interval between horizontal grid lines</span>
        </div>
        <div class="setting-item">
          <div class="slider-container">
            <div class="slider-header"><label class="setting-label">Grid Opacity</label><span id="grid-opacity-val" class="slider-value">100%</span></div>
            <input type="range" id="grid-opacity" min="0" max="100" value="100" step="5">
          </div>
        </div>
        <div class="setting-item">
          <div class="slider-container">
            <div class="slider-header"><label class="setting-label">Grid Line Width</label><span id="grid-line-width-val" class="slider-value">1px</span></div>
            <input type="range" id="grid-line-width" min="0.5" max="3" value="1" step="0.5">
          </div>
        </div>
        <div class="setting-divider"></div>
        <div class="setting-item">
          <label class="setting-label">Base Tick Size</label>
          <input type="number" id="base-tick-input" value="2.5" step="0.5" min="0.5" max="50" class="w-full px-3 py-2">
          <span class="setting-description">Minimum price level grouping</span>
        </div>
        <div class="setting-item">
          <label class="setting-label">Min Cell Height (px)</label>
          <input type="number" id="min-cell-height-input" value="15" step="1" min="8" max="40" class="w-full px-3 py-2">
          <span class="setting-description">Minimum height before auto-scaling kicks in</span>
        </div>
      </div></div>
    </div>

    <!-- Footprint Clusters -->
    <div class="settings-section">
      <div class="section-header" onclick="toggleSection(this)">
        <div class="section-title-wrapper">
          <div class="section-icon"><svg class="icon-svg w-5 h-5" viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg></div>
          <span class="section-title">Footprint Clusters</span>
        </div>
      </div>
      <div class="section-content"><div class="section-body">
        <div class="setting-item">
          <label class="setting-label">Calculation Mode</label>
          <div class="select-wrapper"><select id="cumulative-mode-select" class="w-full px-3 py-2"><option value="all" selected>All Candles</option><option value="visible">Visible Candles Only</option></select></div>
          <span class="setting-description">Cumulative cluster aggregation range</span>
        </div>
        <div class="setting-divider"></div>
        <div class="setting-item">
          <label class="setting-label">Low-Volume Cell Threshold (USD)</label>
          <input type="number" id="cluster-volume-threshold" value="25000" min="0" step="10000" class="w-full px-3 py-2">
          <span class="setting-description">Cells below this total volume are shown in muted gray. Set to 0 to disable.</span>
        </div>
        <div class="setting-divider"></div>
        <div class="setting-item">
          <div class="slider-container">
            <div class="slider-header"><label class="setting-label">Cluster BG Opacity</label><span id="cluster-bg-opacity-val" class="slider-value">0%</span></div>
            <input type="range" id="cluster-bg-opacity" min="0" max="100" value="0" step="5">
          </div>
        </div>
        <div class="setting-item">
          <div class="slider-container">
            <div class="slider-header"><label class="setting-label">POC Border Width</label><span id="poc-border-width-val" class="slider-value">1px</span></div>
            <input type="range" id="poc-border-width" min="1" max="5" value="1.5" step="0.5">
          </div>
        </div>
        <div class="setting-item">
          <div class="slider-container">
            <div class="slider-header"><label class="setting-label">Cell Border Width</label><span id="cell-border-width-val" class="slider-value">1px</span></div>
            <input type="range" id="cell-border-width" min="0" max="3" value="1" step="0.5">
          </div>
        </div>
      </div></div>
    </div>

    <!-- Volume Analysis -->
    <div class="settings-section">
      <div class="section-header" onclick="toggleSection(this)">
        <div class="section-title-wrapper">
          <div class="section-icon"><svg class="icon-svg w-5 h-5" viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg></div>
          <span class="section-title">Volume Analysis</span>
        </div>
      </div>
      <div class="section-content"><div class="section-body">
        <div class="setting-item">
          <label class="setting-label">Min Delta for Bubbles (USD)</label>
          <input type="number" id="bubble-threshold-input" value="500000" step="100000" min="0" max="10000000" class="w-full px-3 py-2">
          <span class="setting-description">Show pulsing indicator when delta exceeds this threshold</span>
        </div>
        <div class="setting-divider"></div>
        <div class="setting-row">
          <div class="setting-item"><label class="setting-label">Bubble Inner Size</label><input type="number" id="bubble-inner-size" value="5" min="2" max="15" step="1" class="w-full px-3 py-2"></div>
          <div class="setting-item"><label class="setting-label">Bubble Outer Size</label><input type="number" id="bubble-outer-size" value="10" min="5" max="25" step="1" class="w-full px-3 py-2"></div>
        </div>
        <div class="setting-item">
          <div class="slider-container">
            <div class="slider-header"><label class="setting-label">Bubble Pulse Speed</label><span id="bubble-pulse-speed-val" class="slider-value">1.5s</span></div>
            <input type="range" id="bubble-pulse-speed" min="500" max="3000" value="1500" step="100">
          </div>
        </div>
        <div class="setting-divider"></div>
        <div class="setting-row">
          <div class="setting-item"><label class="setting-label">Absorption Dot Size</label><input type="number" id="absorption-dot-size" value="4" min="2" max="12" step="1" class="w-full px-3 py-2"></div>
          <div class="setting-item"><label class="setting-label">Absorption Glow</label><input type="number" id="absorption-glow" value="10" min="0" max="30" step="1" class="w-full px-3 py-2"></div>
        </div>
        <div class="setting-item">
          <label class="setting-label">Absorption Threshold (USD)</label>
          <input type="number" id="absorption-threshold" value="1000000" step="10000" min="0" max="10000000" class="w-full px-3 py-2">
          <span class="setting-description">Minimum delta for absorption detection</span>
        </div>
      </div></div>
    </div>

    <!-- UI Elements -->
    <div class="settings-section">
      <div class="section-header" onclick="toggleSection(this)">
        <div class="section-title-wrapper">
          <div class="section-icon"><svg class="icon-svg w-5 h-5" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6m0 0"/><circle cx="12" cy="12" r="10"/></svg></div>
          <span class="section-title">UI Elements</span>
        </div>
      </div>
      <div class="section-content"><div class="section-body">
        <div class="setting-row">
          <div class="setting-item"><label class="setting-label">Price Line</label><div class="toggle-switch active" id="toggle-price-line-switch" onclick="toggleSwitch(this)"></div></div>
          <div class="setting-item"><label class="setting-label">Price Label</label><div class="toggle-switch active" id="toggle-price-label-switch" onclick="toggleSwitch(this)"></div></div>
        </div>
        <div class="setting-row">
          <div class="setting-item"><label class="setting-label">Countdown Timer</label><div class="toggle-switch active" id="toggle-countdown-switch" onclick="toggleSwitch(this)"></div></div>
          <div class="setting-item"><label class="setting-label">Crosshair</label><div class="toggle-switch active" id="toggle-crosshair-switch" onclick="toggleSwitch(this)"></div></div>
        </div>
        <div class="setting-divider"></div>
        <div class="setting-item"><label class="setting-label">Price Label Font Size</label><input type="number" id="price-label-font-size" value="9" min="5" max="20" step="1" class="w-full px-3 py-2"></div>
        <div class="setting-item"><label class="setting-label">Timer Font Size</label><input type="number" id="timer-font-size" value="8" min="5" max="20" step="1" class="w-full px-3 py-2"></div>
        <div class="setting-divider"></div>
        <div class="setting-item">
          <div class="slider-container">
            <div class="slider-header"><label class="setting-label">Timer Opacity</label><span id="timer-opacity-val" class="slider-value">90%</span></div>
            <input type="range" id="timer-opacity" min="0" max="100" value="90" step="5">
          </div>
        </div>
      </div></div>
    </div>

  </div>
</div>

<div id="ctx-menu-main" class="hidden absolute w-52 bg-[#12161f] border border-trade-border rounded-lg shadow-2xl py-1.5 z-[5000] text-sm backdrop-blur-sm">
  <div id="ctx-reset" class="menu-item px-4 py-2.5 hover:bg-blue-600/10 hover:text-blue-400 cursor-pointer flex justify-between items-center text-gray-300 transition-colors group">
    <span class="font-medium">Reset View</span><span class="text-gray-500 text-xs group-hover:text-blue-400">R</span>
  </div>
  <div class="h-px bg-trade-border mx-2 my-1"></div>
  <div id="ctx-hide-footprints" class="menu-item px-4 py-2.5 hover:bg-blue-600/10 hover:text-blue-400 cursor-pointer flex justify-between items-center text-gray-300 transition-colors group">
    <span class="font-medium">Hide Footprints</span>
    <span id="ctx-hide-footprints-indicator" class="text-[10px] text-gray-500 group-hover:text-blue-400">â—‹</span>
  </div>
  <div class="h-px bg-trade-border mx-2 my-1"></div>
  <div id="ctx-settings-trigger" class="menu-item px-4 py-2.5 hover:bg-blue-600/10 hover:text-blue-400 cursor-pointer flex justify-between items-center text-gray-300 transition-colors group">
    <span class="font-medium">Settings</span><span class="text-gray-500 text-[10px] group-hover:text-blue-400">â–¶</span>
  </div>
</div>
<script>
const HEADER_HEIGHT=48,TIME_AXIS_HEIGHT=28,MIN_PANE_HEIGHT=50,BASE_TIMEFRAME=5;

let config={
  gridSpacing:1000,gridColor:'#636363',gridOpacity:1.0,gridLineWidth:1,
  baseTickSize:2.5,minCellHeight:15,upColor:'#608feb',downColor:'#ff4242',
  candleOpacity:1.0,seriesType:'candle',minBubbleVolume:500000,
  showPriceLine:true,showPriceLabel:true,showCountdown:true,showCrosshair:true,
  pocColor:'#f0b90b',currentTimeframe:5,displayTimeframe:5,
  candleWidthPercent:0.20,clusterWidthPercent:0.80,cumulativeMode:'all',
  wickThickness:1,borderThickness:1,bgColor:'#0a0e1a',panelColor:'#0f1419',
  accentColor:'#3b82f6',absorptionColor:'#FFD700',
  statsFontFamily:"'JetBrains Mono', monospace",statsFontSize:9,
  statsFontWeight:'400',cellFontSize:9,cellFontWeight:'400',barSpacing:50,
  clusterBgOpacity:0,pocBorderWidth:1.5,cellBorderWidth:1,
  bubbleInnerSize:5,bubbleOuterSize:10,bubblePulseSpeed:1500,
  absorptionDotSize:4,absorptionGlow:10,absorptionThreshold:1000000,
  priceLabelFontSize:9,timerFontSize:8,timerOpacity:0.9,
  defaultIndicatorHeight:150,oiCandleWidth:0.5,cvdLineThickness:1,
  indicatorPadding:10,indicatorBgOpacity:0.95,drawDelay:100,interactionHold:180,
  clusterVolumeThreshold:25000,showDailyLevels:false,hideFootprints:false,
  priceScaleWidth:44,priceScaleFontSize:10,
  vwapVisible:false,showTPO:false,
  tpoTickSize:100,tpoBlockWidth:8,tpoOpacityVA:0.65,tpoOpacityNonVA:0.70,
  tpoColorSingle:'#ff6ec7',tpoColorVA:'#3b82f6',tpoColorNonVA:'#ffffff',tpoColorPOC:'#ffffff',
  oiUpColor:'#608feb',oiDownColor:'#ff4242',oiOpacity:1.0,oiBorderColor:'#ffffff',
  cvdLineColor:'auto',barStatsUpColor:'#608feb',barStatsDownColor:'#ff4242',
  vwapColor:'#ffffff',vwapLineStyle:'solid',vwapShowLabel:false,vwapShowPrice:false,
  levelsColor:'#ff8c00',levelsLineStyle:'dashed',
  levelsEnabled:{dOpen:true,dHigh:true,dLow:true,dEQ:true,pdHigh:true,pdLow:true,pdEQ:true},
};
let crosshairPos=null;
let base5mClusters={},base5mCandles=[],displayCandles=[],displayClusters={};
let lastBarTime=0,currentPrice=0,mainSeries,ws=null,measuredPriceScaleWidth=54;
let tpoProfilesCache=null,tpoCacheKey='';
let activePriceLabelEl=null,activeTimerBox=null,activeWrapperEl=null;
let myLayout=null,extraPanels=[],extraPanelCounter=0,selectedPanelId=0;
let chart=null,chartOverlayCanvas=null,ctxOverlay=null;
let offscreenCanvas=null,offscreenCtx=null,indicatorManager=null;

const IND_SETTING_KEYS=[
  'oiUpColor','oiDownColor','oiOpacity','oiBorderColor',
  'cvdLineColor','cvdLineThickness',
  'barStatsUpColor','barStatsDownColor',
  'tpoTickSize','tpoBlockWidth','tpoOpacityVA','tpoOpacityNonVA',
  'tpoColorSingle','tpoColorVA','tpoColorNonVA','tpoColorPOC',
  'vwapColor','vwapLineStyle','vwapShowLabel','vwapShowPrice',
  'levelsColor','levelsLineStyle',
];

function makeDefaultIndSettings(){const s={};IND_SETTING_KEYS.forEach(k=>{s[k]=config[k]});s.levelsEnabled={...config.levelsEnabled};return s;}

function _saveP0(){
  const s={};IND_SETTING_KEYS.forEach(k=>{s[k]=config[k]});s.levelsEnabled={...config.levelsEnabled};
  return{chart,mainSeries,chartOverlayCanvas,ctxOverlay,offscreenCanvas,offscreenCtx, crosshairPos,
    displayCandles,displayClusters,tpoProfilesCache,tpoCacheKey,vwapData,vwapCacheKey,
    indicatorManager,activePriceLabelEl,activeTimerBox,activeWrapperEl,
    showTPO:config.showTPO,vwapVisible:config.vwapVisible,
    showDailyLevels:config.showDailyLevels,hideFootprints:config.hideFootprints,indSettings:s};
}
function _restoreP0(s){
  chart=s.chart;mainSeries=s.mainSeries;crosshairPos=s.crosshairPos;chartOverlayCanvas=s.chartOverlayCanvas;ctxOverlay=s.ctxOverlay;
  offscreenCanvas=s.offscreenCanvas;offscreenCtx=s.offscreenCtx;
  displayCandles=s.displayCandles;displayClusters=s.displayClusters;
  tpoProfilesCache=s.tpoProfilesCache;tpoCacheKey=s.tpoCacheKey;
  vwapData=s.vwapData;vwapCacheKey=s.vwapCacheKey;
  indicatorManager=s.indicatorManager;activePriceLabelEl=s.activePriceLabelEl;
  activeTimerBox=s.activeTimerBox;activeWrapperEl=s.activeWrapperEl;
  config.showTPO=s.showTPO;config.vwapVisible=s.vwapVisible;
  config.showDailyLevels=s.showDailyLevels;config.hideFootprints=s.hideFootprints;
  if(s.indSettings){IND_SETTING_KEYS.forEach(k=>{config[k]=s.indSettings[k]});config.levelsEnabled={...s.indSettings.levelsEnabled};}
}
function _activatePanel(p){
  chart=p.chart;mainSeries=p.mainSeries;chartOverlayCanvas=p.overlayCanvas;ctxOverlay=p.ctxOverlay;
  offscreenCanvas=p.offscreenCanvas;offscreenCtx=p.offscreenCtx;
  displayCandles=p.displayCandles;displayClusters=p.displayClusters;
  tpoProfilesCache=p.tpoProfilesCache;tpoCacheKey=p.tpoCacheKey;
  indicatorManager=p.indicatorManager;activePriceLabelEl=p.priceLabelEl;
  activeTimerBox=p.timerBoxEl;activeWrapperEl=p.wrapperEl;
  config.showTPO=p.showTPO;config.vwapVisible=p.vwapVisible;
  config.showDailyLevels=p.showDailyLevels;config.hideFootprints=p.hideFootprints; crosshairPos=p.crosshairPos||null;
  IND_SETTING_KEYS.forEach(k=>{if(p[k]!==undefined)config[k]=p[k]});
  if(p.levelsEnabled)config.levelsEnabled={...p.levelsEnabled};
}
function _deactivatePanel(p){
  p.tpoProfilesCache=tpoProfilesCache;p.tpoCacheKey=tpoCacheKey;
  p.showTPO=config.showTPO;p.vwapVisible=config.vwapVisible;
  p.showDailyLevels=config.showDailyLevels;p.hideFootprints=config.hideFootprints;
  IND_SETTING_KEYS.forEach(k=>{p[k]=config[k]});p.levelsEnabled={...config.levelsEnabled};
}

function schedulePanelDraw(panel){
  panel.needsRedraw=true;panel.lastInteractionTime=Date.now();
  if(!panel.rafRunning){
    panel.rafRunning=true;
    const loop=()=>{
      const saved=_saveP0();_activatePanel(panel);
      const now=Date.now();
      if(now-panel.lastInteractionTime<config.interactionHold){
        drawFrames();_deactivatePanel(panel);_restoreP0(saved);panel.rafId=requestAnimationFrame(loop);
      }else if(panel.needsRedraw){
        panel.needsRedraw=false;drawFrames();_deactivatePanel(panel);_restoreP0(saved);panel.rafId=requestAnimationFrame(loop);
      }else{_restoreP0(saved);panel.rafRunning=false;panel.rafId=null;}
    };
    panel.rafId=requestAnimationFrame(loop);
  }
}
function setupPanelBuffers(panel){
  const dpr=window.devicePixelRatio||1,w=panel.wrapperEl.clientWidth,h=panel.wrapperEl.clientHeight;
  panel.overlayCanvas.width=Math.floor(w*dpr);panel.overlayCanvas.height=Math.floor(h*dpr);
  panel.overlayCanvas.style.width=w+'px';panel.overlayCanvas.style.height=h+'px';
  panel.offscreenCanvas.width=panel.overlayCanvas.width;panel.offscreenCanvas.height=panel.overlayCanvas.height;
  panel.offscreenCtx.setTransform(dpr,0,0,dpr,0,0);panel.ctxOverlay.setTransform(1,0,0,1,0,0);
  panel.chart.applyOptions({width:w,height:h});
}

// â”€â”€ Golden Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initGoldenLayout(){
  const glConfig={root:{type:'row',content:[{type:'component',componentType:'chartComponent',componentState:{isMain:true},title:'BTCUSD Main'}]},settings:{showPopoutIcon:false}};
  myLayout=new window.goldenLayout.GoldenLayout(glConfig,document.getElementById('charts-container'));

  myLayout.registerComponentFactoryFunction('chartComponent',function(container,itemConfig){
    const state=itemConfig.componentState||itemConfig||{};
    const isMain=state.isMain===true;
    const pid=isMain?0:++extraPanelCounter;

    const wrapperEl=document.createElement('div');
    wrapperEl.className='chart-panel-wrapper';wrapperEl.id=`panel-wrapper-${pid}`;
    if(isMain)wrapperEl.classList.add('selected');

    const chartContEl=document.createElement('div');
    chartContEl.style.cssText='width:100%;height:100%;';
    const overlayEl=document.createElement('canvas');
    overlayEl.style.cssText='position:absolute;top:0;left:0;pointer-events:none;z-index:20;';
    const priceLabelEl=document.createElement('div');
    priceLabelEl.style.cssText='position:absolute;right:0;z-index:40;pointer-events:none;display:flex;align-items:center;gap:1px;';
    const timerEl=document.createElement('div');
    timerEl.className='hidden absolute bg-black/90 border border-trade-border/50 backdrop-blur text-white px-1 py-1 font-mono text-[11px] font-semibold z-[60] tabular-nums flex items-center gap-1.5 pointer-events-none shadow-lg rounded';
    timerEl.style.cssText='min-width:60px;right:10px;top:50%;transform:translateY(-50%);';
    const indicatorsContainer=document.createElement('div');
    indicatorsContainer.id=`indicators-container-${pid}`;
    indicatorsContainer.style.cssText='position:absolute;left:0;right:0;bottom:0;pointer-events:none;';
    wrapperEl.append(chartContEl,overlayEl,priceLabelEl,timerEl,indicatorsContainer);

    if(!isMain){
      const tfBar=document.createElement('div');tfBar.className='panel-tf-bar';
      [5,15,30,60,240,1440].forEach(tf=>{
        const btn=document.createElement('button');
        btn.className='timeframe-btn'+(tf===5?' active':'');
        btn.style.cssText='padding:2px 7px;font-size:10px;';
        btn.textContent={5:'5m',15:'15m',30:'30m',60:'1h',240:'4h',1440:'1D'}[tf];
        btn.onclick=()=>{
          tfBar.querySelectorAll('.timeframe-btn').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');panel.displayTimeframe=tf;
          panel.displayCandles=aggregateCandles(base5mCandles,tf);
          panel.displayClusters=aggregateClusters(base5mClusters,tf);
          panel.mainSeries.setData(panel.displayCandles);panel.tpoCacheKey='';
          setTimeout(()=>{panel.chart.timeScale().fitContent();schedulePanelDraw(panel);},80);
        };
        tfBar.appendChild(btn);
      });
      wrapperEl.appendChild(tfBar);
    }
    container.element.appendChild(wrapperEl);

    wrapperEl.addEventListener('mousedown',()=>{
      selectedPanelId=pid;
      document.querySelectorAll('.chart-panel-wrapper').forEach(w=>w.classList.remove('selected'));
      wrapperEl.classList.add('selected');syncHeaderButtons();
    });
    wrapperEl.addEventListener('contextmenu',(e)=>{
      e.preventDefault();selectedPanelId=pid;
      document.querySelectorAll('.chart-panel-wrapper').forEach(w=>w.classList.remove('selected'));
      wrapperEl.classList.add('selected');syncHeaderButtons();
      const m=document.getElementById('ctx-menu-main');
      m.style.left=`${Math.min(e.clientX,window.innerWidth-200)}px`;
      m.style.top=`${Math.min(e.clientY,window.innerHeight-100)}px`;
      m.classList.remove('hidden');
    });

    const newChart=LightweightCharts.createChart(chartContEl,{
      localization:{timeFormatter:(ts)=>new Date(ts*1000).toLocaleString('ro-RO',{timeZone:'Europe/Bucharest',hour:'2-digit',minute:'2-digit'})},
      layout:{background:{color:config.bgColor},textColor:'#8b92a7',fontFamily:'Inter',fontSize:config.priceScaleFontSize},
      grid:{vertLines:{visible:false},horzLines:{visible:false}},
      rightPriceScale:{borderColor:'#1a1f2e',scaleMargins:{top:0.05,bottom:0.20}},
      crosshair:{mode:LightweightCharts.CrosshairMode.Normal},
      timeScale:{borderColor:'#1a1f2e',timeVisible:true,barSpacing:config.barSpacing,rightOffset:5}
    });
    const newSeries=newChart.addCandlestickSeries({
      upColor:'rgba(0,0,0,0)',downColor:'rgba(0,0,0,0)',borderVisible:false,
      wickUpColor:'rgba(0,0,0,0)',wickDownColor:'rgba(0,0,0,0)',
      priceLineVisible:config.showPriceLine,priceLineColor:config.upColor,priceLineWidth:1,priceLineStyle:2,lastValueVisible:false
    });
    const offscreenC=document.createElement('canvas');

    if(isMain){
      chart=newChart;mainSeries=newSeries;chartOverlayCanvas=overlayEl;ctxOverlay=overlayEl.getContext('2d');
      offscreenCanvas=offscreenC;offscreenCtx=offscreenC.getContext('2d');
      activePriceLabelEl=priceLabelEl;activeTimerBox=timerEl;activeWrapperEl=wrapperEl;
      if(typeof IndicatorManager!=='undefined'){
        indicatorManager=new IndicatorManager();indicatorManager.chart=chart;
        indicatorManager.wrapper=wrapperEl;indicatorManager.container=indicatorsContainer;
        indicatorManager.onLayout=()=>scheduleDraw();
      }
    }
    const panelIndicatorManager=isMain?indicatorManager:new IndicatorManager();
    if(!isMain){
      panelIndicatorManager.container=indicatorsContainer;
      panelIndicatorManager.chart=newChart;panelIndicatorManager.wrapper=wrapperEl;
    }
    const panel=isMain?null:{
      id:pid,indicatorManager:panelIndicatorManager,wrapperEl,chart:newChart,mainSeries:newSeries,
      overlayCanvas:overlayEl,ctxOverlay:overlayEl.getContext('2d'),offscreenCanvas:offscreenC,offscreenCtx:offscreenC.getContext('2d'),
      priceLabelEl,timerBoxEl:timerEl,displayTimeframe:5,displayCandles:displayCandles.slice(),displayClusters:structuredClone(displayClusters),
      tpoProfilesCache:null,tpoCacheKey:'',rafRunning:false,needsRedraw:false,lastInteractionTime:0,rafId:null,
      showTPO:false,vwapVisible:false,showDailyLevels:false,hideFootprints:false,...makeDefaultIndSettings(),
    };
    if(!isMain){
      panelIndicatorManager.onLayout=()=>schedulePanelDraw(panel);
      newSeries.setData(panel.displayCandles);extraPanels.push(panel);
      newChart.timeScale().subscribeVisibleLogicalRangeChange(()=>schedulePanelDraw(panel));
      newChart.subscribeCrosshairMove(param=>{panel.crosshairPos=param.point||null;});
    }
    const ro=new ResizeObserver((entries)=>{
      for(const entry of entries){
        const w=Math.floor(entry.contentRect.width),h=Math.floor(entry.contentRect.height);
        if(w===0||h===0)continue;
        if(isMain){chart.applyOptions({width:w,height:h});setupBuffersForSize();if(indicatorManager)indicatorManager.updateLayout();scheduleDraw();}
        else if(panel){panel.chart.applyOptions({width:w,height:h});setupPanelBuffers(panel);panel.indicatorManager.updateLayout();schedulePanelDraw(panel);}
      }
    });
    ro.observe(wrapperEl);
    container.on('destroy',()=>{
      ro.disconnect();
      if(isMain){if(rafId){cancelAnimationFrame(rafId);rafId=null;}rafRunning=false;}
      else{if(panel.rafId)cancelAnimationFrame(panel.rafId);const idx=extraPanels.findIndex(p=>p.id===pid);if(idx>-1)extraPanels.splice(idx,1);panel.chart.remove();}
    });
  });

  myLayout.init();
  myLayout.on('initialised',()=>{
    requestAnimationFrame(()=>requestAnimationFrame(()=>{
      if(chart&&activeWrapperEl&&activeWrapperEl.clientWidth>0){
        chart.applyOptions({width:activeWrapperEl.clientWidth,height:activeWrapperEl.clientHeight});
        setupBuffersForSize();if(indicatorManager)indicatorManager.updateLayout();
      }
      extraPanels.forEach(p=>{if(p.wrapperEl&&p.wrapperEl.clientWidth>0){setupPanelBuffers(p);p.indicatorManager.updateLayout();schedulePanelDraw(p);}});
      scheduleDraw();
    }));
  });
  window.addEventListener('resize',()=>myLayout.updateSize());
}

// â”€â”€ Global Draw Loop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let rafId=null,rafRunning=false,needsRedraw=false,lastInteractionTime=0,clustersDirty=false;

function updatePaneRight(){
  let right=54;
  if(activeWrapperEl){const td=activeWrapperEl.querySelector('tr td:last-child');if(td){const w=Math.round(td.getBoundingClientRect().width);if(w>10)right=w;}}
  measuredPriceScaleWidth=right;
  const updatePanes=w=>{w.querySelectorAll('.indicator-pane').forEach(el=>{el.style.right=right+'px'});const ph=w.querySelector('.drag-placeholder');if(ph)ph.style.right=right+'px';};
  if(indicatorManager?.wrapper)updatePanes(indicatorManager.wrapper);
  extraPanels.forEach(p=>updatePanes(p.wrapperEl));
}
function scheduleDraw(){
  needsRedraw=true;lastInteractionTime=Date.now();
  extraPanels.forEach(p=>schedulePanelDraw(p));
  if(!rafRunning){
    rafRunning=true;
    const loop=()=>{
      const now=Date.now();
      if(now-lastInteractionTime<config.interactionHold){drawFrames();rafId=requestAnimationFrame(loop);}
      else if(needsRedraw){needsRedraw=false;drawFrames();rafId=requestAnimationFrame(loop);}
      else{rafRunning=false;rafId=null;}
    };
    rafId=requestAnimationFrame(loop);
  }
}

// â”€â”€ Timeframe Aggregation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseCustomTimeframe(input){
  input=input.trim().toLowerCase();
  if(input.endsWith('h')){const h=parseFloat(input.slice(0,-1));return(isNaN(h)||h<=0)?null:h*60;}
  if(input.endsWith('d')){const d=parseFloat(input.slice(0,-1));return(isNaN(d)||d<=0)?null:d*1440;}
  if(input.endsWith('w')){const w=parseFloat(input.slice(0,-1));return(isNaN(w)||w<=0)?null:w*10080;}
  if(input.endsWith('m')&&input.length>1&&!isNaN(input[input.length-2])){const m=parseFloat(input.slice(0,-1));return(isNaN(m)||m<=0)?null:m;}
  const mins=parseFloat(input);return(isNaN(mins)||mins<=0)?null:mins;
}
function validateTimeframe(minutes){
  if(minutes<BASE_TIMEFRAME){alert(`Footprint information will not migrate to timeframes lower than ${BASE_TIMEFRAME}m`);return false;}
  if(minutes%BASE_TIMEFRAME!==0){alert(`Please use timeframes divisible by ${BASE_TIMEFRAME}m`);return false;}
  return true;
}
function aggregateCandles(src,targetTF){
  if(targetTF===BASE_TIMEFRAME)return src.slice();
  const tbs=targetTF*60,grouped={};
  src.forEach(c=>{const a=Math.floor(c.time/tbs)*tbs;if(!grouped[a])grouped[a]=[];grouped[a].push(c);});
  return Object.keys(grouped).map(Number).sort((a,b)=>a-b).map(t=>{
    const chunk=grouped[t],first=chunk[0],last=chunk[chunk.length-1];
    return{time:t,open:first.open,high:Math.max(...chunk.map(c=>c.high)),low:Math.min(...chunk.map(c=>c.low)),
      close:last.close,oiOpen:first.oiOpen,volume:chunk.reduce((s,c)=>s+(c.volume||0),0),
      oiHigh:Math.max(...chunk.map(c=>c.oiHigh||0)),oiLow:Math.min(...chunk.map(c=>c.oiLow||Infinity)),oiClose:last.oiClose};
  });
}
function aggregateClusters(src,targetTF){
  if(targetTF===BASE_TIMEFRAME){
    const copy={};for(const ts in src){const s=src[ts],d={};for(const p in s)d[p]={buy:s[p].buy,sell:s[p].sell};copy[ts]=d;}return copy;
  }
  const tbs=targetTF*60,agg={},grouped={};
  Object.keys(src).map(Number).sort((a,b)=>a-b).forEach(ts=>{const a=Math.floor(ts/tbs)*tbs;if(!grouped[a])grouped[a]=[];grouped[a].push(ts);});
  Object.keys(grouped).forEach(at=>{
    const tk=String(at),list=grouped[at];
    if(!list.some(ts=>{const b=src[String(ts)];return b&&Object.keys(b).length>0}))return;
    agg[tk]={};
    list.forEach(ts=>{
      const buckets=src[String(ts)];if(!buckets)return;
      Object.keys(buckets).forEach(pk=>{
        const price=parseFloat(pk),data=buckets[pk];
        if(data.buy===0&&data.sell===0)return;
        if(!agg[tk][price])agg[tk][price]={buy:0,sell:0};
        agg[tk][price].buy+=data.buy;agg[tk][price].sell+=data.sell;
      });
    });
    if(Object.keys(agg[tk]).length===0)delete agg[tk];
  });
  return agg;
}
function applyTimeframeChange(newTF){
  config.displayTimeframe=newTF;
  displayCandles=aggregateCandles(base5mCandles,newTF);
  displayClusters=aggregateClusters(base5mClusters,newTF);
  mainSeries.setData(displayCandles);tpoCacheKey='';
  document.querySelectorAll('.timeframe-btn').forEach(b=>b.classList.remove('active'));
  const tfMap={1:1,3:3,5:5,15:15,30:30,60:60,240:240,1440:'D'};
  const bv=tfMap[newTF];if(bv){const b=document.querySelector(`[data-tf="${bv}"]`);if(b)b.classList.add('active');}
  setTimeout(()=>{chart.timeScale().fitContent();needsRedraw=true;scheduleDraw();},100);
}

// Modal bindings
document.getElementById('custom-tf-btn').onclick=()=>{document.getElementById('custom-tf-modal').classList.add('active');document.getElementById('custom-tf-input').value='';document.getElementById('custom-tf-input').focus();};
document.getElementById('custom-tf-cancel').onclick=()=>document.getElementById('custom-tf-modal').classList.remove('active');
document.getElementById('custom-tf-modal').onclick=(e)=>{if(e.target.id==='custom-tf-modal')document.getElementById('custom-tf-modal').classList.remove('active');};
document.getElementById('custom-tf-input').onkeypress=(e)=>{if(e.key==='Enter')document.getElementById('custom-tf-confirm').click();};
document.getElementById('custom-tf-confirm').onclick=()=>{
  const input=document.getElementById('custom-tf-input').value,minutes=parseCustomTimeframe(input);
  if(minutes===null){alert('Invalid timeframe format. Examples: 15, 1h, 4h, 1d, 1w');return;}
  if(!validateTimeframe(minutes))return;
  document.getElementById('custom-tf-modal').classList.remove('active');applyTimeframeChange(minutes);
};

function toggleSection(h){h.parentElement.classList.toggle('expanded');}
function toggleSwitch(el){
  el.classList.toggle('active');const id=el.id;
  if(id==='toggle-price-line-switch'){
    config.showPriceLine=el.classList.contains('active');
    const lc=displayCandles[displayCandles.length-1];
    mainSeries.applyOptions({priceLineVisible:config.showPriceLine,priceLineColor:(lc&&lc.close>=lc.open)?config.upColor:config.downColor,priceLineWidth:1,priceLineStyle:2});
  }else if(id==='toggle-price-label-switch'){config.showPriceLabel=el.classList.contains('active');scheduleDraw();}
  else if(id==='toggle-countdown-switch'){config.showCountdown=el.classList.contains('active');scheduleDraw();}
  else if(id==='toggle-crosshair-switch'){config.showCrosshair=el.classList.contains('active');chart.applyOptions({crosshair:{vertLine:{visible:config.showCrosshair},horzLine:{visible:config.showCrosshair}}});}
}

function resetToDefaults(){
  if(!confirm('Reset all settings to default values? This cannot be undone.'))return;
  config={
    gridSpacing:1000,gridColor:'#636363',gridOpacity:1.0,gridLineWidth:1,
    baseTickSize:2.5,minCellHeight:15,upColor:'#608feb',downColor:'#ff4242',
    candleOpacity:1.0,seriesType:'candle',minBubbleVolume:500000,
    showPriceLine:true,showPriceLabel:true,showCountdown:true,showCrosshair:true,
    pocColor:'#f0b90b',currentTimeframe:5,displayTimeframe:5,candleWidthPercent:0.20,
    clusterWidthPercent:0.80,cumulativeMode:'all',wickThickness:1,borderThickness:1,
    bgColor:'#0a0e1a',panelColor:'#0f1419',accentColor:'#3b82f6',absorptionColor:'#FFD700',
    statsFontFamily:"'JetBrains Mono', monospace",statsFontSize:11,statsFontWeight:'600',
    cellFontSize:11,cellFontWeight:'400',barSpacing:50,clusterBgOpacity:0,pocBorderWidth:1.5,
    cellBorderWidth:1,bubbleInnerSize:5,bubbleOuterSize:10,bubblePulseSpeed:1500,
    absorptionDotSize:4,absorptionGlow:10,absorptionThreshold:1000000,
    priceLabelFontSize:9,timerFontSize:8,timerOpacity:0.9,
    defaultIndicatorHeight:150,oiCandleWidth:0.5,cvdLineThickness:1,
    indicatorPadding:10,indicatorBgOpacity:0.95,drawDelay:100,interactionHold:180,
    clusterVolumeThreshold:25000,showTPO:false,tpoTickSize:100,tpoBlockWidth:8,
    tpoOpacityVA:0.65,tpoOpacityNonVA:0.70,tpoColorSingle:'#ff6ec7',tpoColorVA:'#3b82f6',
    tpoColorNonVA:'#ffffff',tpoColorPOC:'#ffffff',priceScaleWidth:44,priceScaleFontSize:10,
  };
  tpoCacheKey='';
  const setV=(id,v)=>{const el=document.getElementById(id);if(el)el.value=v;};
  const setT=(id,v)=>{const el=document.getElementById(id);if(el)el.textContent=v;};
  setV('series-type-select','candle');setV('bar-spacing-input',50);
  setV('candle-opacity',100);setT('opacity-val','100%');
  setV('candle-width-input',20);setV('cluster-width-input',80);
  setV('wick-thickness',1);setT('wick-thickness-val','1px');
  setV('border-thickness',1);setT('border-thickness-val','1px');
  setV('up-candle-color','#608feb');setV('down-candle-color','#ff4242');
  setV('grid-color-input','#636363');setV('poc-color-input','#f0b90b');
  setV('bg-color-input','#0a0e1a');setV('panel-color-input','#0f1419');
  setV('accent-color-input','#3b82f6');setV('absorption-color-input','#FFD700');
  setV('grid-spacing-input',1000);setV('grid-opacity',100);setT('grid-opacity-val','100%');
  setV('grid-line-width',1);setT('grid-line-width-val','1px');
  setV('base-tick-input',2.5);setV('min-cell-height-input',15);
  setV('cumulative-mode-select','all');setV('cluster-volume-threshold',50000);
  setV('cluster-bg-opacity',0);setT('cluster-bg-opacity-val','0%');
  setV('poc-border-width',1.5);setT('poc-border-width-val','1.5px');
  setV('cell-border-width',1);setT('cell-border-width-val','1px');
  setV('bubble-threshold-input',500000);setV('bubble-inner-size',5);setV('bubble-outer-size',10);
  setV('bubble-pulse-speed',1500);setT('bubble-pulse-speed-val','1.5s');
  setV('absorption-dot-size',4);setV('absorption-glow',10);setV('absorption-threshold',100000);
  document.getElementById('toggle-price-line-switch').classList.remove('active');
  ['toggle-price-label-switch','toggle-countdown-switch','toggle-crosshair-switch'].forEach(id=>document.getElementById(id).classList.add('active'));
  setV('price-label-font-size',10);setV('timer-font-size',11);
  setV('timer-opacity',90);setT('timer-opacity-val','90%');
  updateCandleAppearance();
  chart.applyOptions({rightPriceScale:{width:44},layout:{background:{color:config.bgColor},fontSize:10},timeScale:{barSpacing:config.barSpacing}});
  mainSeries.applyOptions({priceLineVisible:config.showPriceLine});
  chart.applyOptions({crosshair:{vertLine:{visible:config.showCrosshair},horzLine:{visible:config.showCrosshair}}});
  applyTimeframeChange(5);
}

// â”€â”€ Settings listeners â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Helper: bind range/number input with optional display label update
function _bindInput(id,cb){document.getElementById(id).addEventListener('input',e=>cb(e.target.value));}
function _bindChange(id,cb){document.getElementById(id).addEventListener('change',e=>cb(e.target.value));}
function _lbl(id,txt){document.getElementById(id).textContent=txt;}

_bindInput('bar-spacing-input',v=>{config.barSpacing=parseInt(v);chart.timeScale().applyOptions({barSpacing:config.barSpacing});scheduleDraw();});
_bindInput('candle-width-input',v=>{config.candleWidthPercent=parseInt(v)/100;scheduleDraw();});
_bindInput('cluster-width-input',v=>{config.clusterWidthPercent=parseInt(v)/100;scheduleDraw();});
_bindInput('wick-thickness',v=>{config.wickThickness=parseFloat(v);_lbl('wick-thickness-val',v+'px');scheduleDraw();});
_bindInput('border-thickness',v=>{config.borderThickness=parseFloat(v);_lbl('border-thickness-val',v+'px');scheduleDraw();});
_bindChange('bg-color-input',v=>{config.bgColor=v;chart.applyOptions({layout:{background:{color:v}}});});
_bindChange('panel-color-input',v=>{config.panelColor=v;});
_bindChange('accent-color-input',v=>{config.accentColor=v;});
_bindChange('poc-color-input',v=>{config.pocColor=v;scheduleDraw();});
_bindChange('absorption-color-input',v=>{config.absorptionColor=v;scheduleDraw();});
_bindInput('grid-opacity',v=>{config.gridOpacity=parseInt(v)/100;_lbl('grid-opacity-val',v+'%');scheduleDraw();});
_bindInput('grid-line-width',v=>{config.gridLineWidth=parseFloat(v);_lbl('grid-line-width-val',v+'px');scheduleDraw();});
_bindChange('base-tick-input',v=>{config.baseTickSize=parseFloat(v);scheduleDraw();});
_bindChange('min-cell-height-input',v=>{config.minCellHeight=parseInt(v);scheduleDraw();});
_bindInput('cluster-bg-opacity',v=>{config.clusterBgOpacity=parseInt(v)/100;_lbl('cluster-bg-opacity-val',v+'%');scheduleDraw();});
_bindInput('poc-border-width',v=>{config.pocBorderWidth=parseFloat(v);_lbl('poc-border-width-val',v+'px');scheduleDraw();});
_bindInput('cell-border-width',v=>{config.cellBorderWidth=parseFloat(v);_lbl('cell-border-width-val',v+'px');scheduleDraw();});
_bindInput('cluster-volume-threshold',v=>{config.clusterVolumeThreshold=parseFloat(v)||0;scheduleDraw();});
_bindInput('bubble-inner-size',v=>{config.bubbleInnerSize=parseInt(v);scheduleDraw();});
_bindInput('bubble-outer-size',v=>{config.bubbleOuterSize=parseInt(v);scheduleDraw();});
_bindInput('bubble-pulse-speed',v=>{config.bubblePulseSpeed=parseInt(v);_lbl('bubble-pulse-speed-val',(v/1000).toFixed(1)+'s');scheduleDraw();});
_bindInput('absorption-dot-size',v=>{config.absorptionDotSize=parseInt(v);scheduleDraw();});
_bindInput('absorption-glow',v=>{config.absorptionGlow=parseInt(v);scheduleDraw();});
_bindInput('absorption-threshold',v=>{config.absorptionThreshold=parseInt(v);scheduleDraw();});
_bindInput('price-label-font-size',v=>{config.priceLabelFontSize=parseInt(v);scheduleDraw();});
_bindInput('timer-font-size',v=>{config.timerFontSize=parseInt(v);scheduleDraw();});
_bindInput('timer-opacity',v=>{config.timerOpacity=parseInt(v)/100;_lbl('timer-opacity-val',v+'%');scheduleDraw();});
_bindInput('price-scale-font-input',v=>{
  config.priceScaleFontSize=parseInt(v);
  chart.applyOptions({layout:{fontSize:config.priceScaleFontSize}});
  extraPanels.forEach(p=>p.chart.applyOptions({layout:{fontSize:config.priceScaleFontSize}}));
  scheduleDraw();
});

function getVisibleCandles(cssWidth){
  const vc=[];if(!displayCandles)return vc;
  for(let i=0;i<displayCandles.length;i++){
    const c=displayCandles[i],x=chart.timeScale().timeToCoordinate(c.time);
    if(x===null||x<-100||x>cssWidth+100)continue;vc.push({i,x,candle:c});
  }
  return vc;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TPO / Market Profile Engine
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildTPOProfiles(){
  if(!displayCandles||displayCandles.length===0)return[];
  const tickSize=Math.max(1,config.tpoTickSize),dayGroups={};
  displayCandles.forEach(c=>{const d=Math.floor(c.time/86400)*86400;if(!dayGroups[d])dayGroups[d]=[];dayGroups[d].push(c);});
  const profiles=[],PERIOD_SECONDS=1800;
  Object.keys(dayGroups).map(Number).sort((a,b)=>a-b).forEach(dayStart=>{
    const candles=dayGroups[dayStart];if(!candles||candles.length===0)return;
    const periodGroups={};
    candles.forEach(c=>{const pi=Math.floor((c.time-dayStart)/PERIOD_SECONDS);if(!periodGroups[pi])periodGroups[pi]=[];periodGroups[pi].push(c);});
    const rowMap={};
    Object.values(periodGroups).forEach(pCandles=>{
      let pH=-Infinity,pL=Infinity;
      pCandles.forEach(c=>{if(c.high>pH)pH=c.high;if(c.low<pL)pL=c.low;});
      const rL=Math.floor(pL/tickSize)*tickSize,rH=Math.floor(pH/tickSize)*tickSize,hit=new Set();
      for(let p=rL;p<=rH+tickSize*0.001;p+=tickSize){const k=Math.round(p);if(!hit.has(k)){hit.add(k);rowMap[k]=(rowMap[k]||0)+1;}}
    });
    const rowKeys=Object.keys(rowMap);if(rowKeys.length===0)return;
    let totalTPO=0;rowKeys.forEach(k=>{totalTPO+=rowMap[k];});
    let pocPrice=null,pocCount=0;
    rowKeys.forEach(k=>{if(rowMap[k]>pocCount){pocCount=rowMap[k];pocPrice=parseFloat(k);}});
    const sortedPrices=rowKeys.map(Number).sort((a,b)=>a-b);
    const pocIdx=sortedPrices.findIndex(p=>Math.abs(p-pocPrice)<0.5);
    const vaTarget=totalTPO*0.70;let vaCount=pocCount,vaLow=pocPrice,vaHigh=pocPrice,upIdx=pocIdx+1,downIdx=pocIdx-1;
    while(vaCount<vaTarget){
      const hasUp=upIdx<sortedPrices.length,hasDown=downIdx>=0;if(!hasUp&&!hasDown)break;
      const upAdd=hasUp?rowMap[sortedPrices[upIdx]]:0,downAdd=hasDown?rowMap[sortedPrices[downIdx]]:0;
      if(hasUp&&upAdd>=downAdd){vaCount+=upAdd;vaHigh=sortedPrices[upIdx];upIdx++;}
      else if(hasDown){vaCount+=downAdd;vaLow=sortedPrices[downIdx];downIdx--;}
      else{vaCount+=upAdd;vaHigh=sortedPrices[upIdx];upIdx++;}
    }
    const singlePrints=new Set();rowKeys.forEach(k=>{if(rowMap[k]===1)singlePrints.add(parseFloat(k));});
    const poorHighPrints=new Set(),poorLowPrints=new Set();
    let phPrev=Infinity;
    for(let i=sortedPrices.length-1;i>=0;i--){const c=rowMap[sortedPrices[i]];if(c>=2&&c<=phPrev){poorHighPrints.add(sortedPrices[i]);phPrev=c;}else break;}
    let plPrev=Infinity;
    for(let i=0;i<sortedPrices.length;i++){const c=rowMap[sortedPrices[i]];if(c>=2&&c<=plPrev){poorLowPrints.add(sortedPrices[i]);plPrev=c;}else break;}
    const maxBlocks=Math.max(...Object.values(rowMap));
    const sessionHigh=Math.max(...candles.map(c=>c.high)),sessionLow=Math.min(...candles.map(c=>c.low));
    const topExtremes=new Set(),bottomExtremes=new Set();
    if(sortedPrices.length>0){
      const tp=sortedPrices[sortedPrices.length-1];if(rowMap[tp]>=2)topExtremes.add(tp);
      const bp=sortedPrices[0];if(rowMap[bp]>=2)bottomExtremes.add(bp);
    }
    profiles.push({dayStart,firstCandleTime:candles[0].time,rowMap,sortedPrices,pocPrice,pocCount,
      vaLow,vaHigh,totalTPO,singlePrints,maxBlocks,sessionHigh,sessionLow,tickSize,
      topExtremes,bottomExtremes,sessionEndTime:candles[candles.length-1].time,poorHighPrints,poorLowPrints});
  });
  return profiles;
}

function drawTPO(cssWidth,candleBottomY){
  if(!config.showTPO)return;
  const lastC=displayCandles[displayCandles.length-1];
  const newKey=`${displayCandles.length}_${lastC?.time??0}_${Math.round(lastC?.high??0)}_${Math.round(lastC?.low??0)}_${config.tpoTickSize}`;
  if(newKey!==tpoCacheKey||!tpoProfilesCache){tpoProfilesCache=buildTPOProfiles();tpoCacheKey=newKey;}
  if(!tpoProfilesCache||tpoProfilesCache.length===0)return;
  const timeScale=chart.timeScale(),blockW=Math.max(2,config.tpoBlockWidth);
  tpoProfilesCache.forEach(profile=>{
    const anchorX=timeScale.timeToCoordinate(profile.firstCandleTime);if(anchorX===null)return;
    if(anchorX+profile.maxBlocks*blockW<-50||anchorX>cssWidth+50)return;
    const{rowMap,sortedPrices,pocPrice,vaLow,vaHigh,singlePrints,tickSize,poorHighPrints,poorLowPrints}=profile;
    sortedPrices.forEach(price=>{
      const count=rowMap[price];
      const yTop=mainSeries.priceToCoordinate(price+tickSize),yBottom=mainSeries.priceToCoordinate(price);
      if(yTop===null||yBottom===null)return;
      const rowY=Math.min(yTop,yBottom),rowH=Math.max(1,Math.abs(yBottom-yTop)-1);
      if(rowY>candleBottomY||rowY+rowH<0)return;
      const isSingle=singlePrints.has(price),isInVA=price>=vaLow&&price<=vaHigh,isPOC=Math.abs(price-pocPrice)<0.5;
      const isPoorExtreme=poorHighPrints.has(price)||poorLowPrints.has(price);
      let fillColor,fillAlpha;
      if(isPoorExtreme){fillColor='#84cc16';fillAlpha=Math.min(1,config.tpoOpacityVA+0.15);}
      else if(isSingle){fillColor=config.tpoColorSingle;fillAlpha=Math.min(1,config.tpoOpacityVA+0.20);}
      else if(isInVA){fillColor=config.tpoColorVA;fillAlpha=config.tpoOpacityVA;}
      else{fillColor=config.tpoColorNonVA;fillAlpha=config.tpoOpacityNonVA;}
      const drawableBlocks=Math.min(count,Math.ceil((cssWidth-anchorX)/blockW));
      for(let b=0;b<drawableBlocks;b++){
        const bx=anchorX+b*blockW;if(bx>cssWidth-2)break;
        offscreenCtx.fillStyle=hexToRgba(fillColor,fillAlpha);
        offscreenCtx.fillRect(bx,rowY,Math.min(blockW-1,cssWidth-bx-1),rowH);
      }
      if(isPOC&&count>0){
        offscreenCtx.save();offscreenCtx.strokeStyle=config.tpoColorPOC;offscreenCtx.lineWidth=1.5;
        offscreenCtx.shadowColor=config.tpoColorPOC;offscreenCtx.shadowBlur=4;
        offscreenCtx.strokeRect(anchorX,rowY,Math.min(count*blockW,cssWidth-anchorX-2),rowH);
        offscreenCtx.restore();
      }
    });
    offscreenCtx.save();offscreenCtx.strokeStyle='rgba(255,255,255,0.06)';offscreenCtx.lineWidth=1;offscreenCtx.setLineDash([3,5]);
    offscreenCtx.beginPath();offscreenCtx.moveTo(anchorX,0);offscreenCtx.lineTo(anchorX,candleBottomY);offscreenCtx.stroke();offscreenCtx.setLineDash([]);offscreenCtx.restore();
    const labelX=anchorX+profile.maxBlocks*blockW+4;
    if(labelX<cssWidth-10){
      offscreenCtx.save();offscreenCtx.font="600 9px 'JetBrains Mono',monospace";offscreenCtx.textAlign='left';
      const pocY=mainSeries.priceToCoordinate(pocPrice+tickSize/2);
      if(pocY!==null&&pocY>0&&pocY<candleBottomY){offscreenCtx.fillStyle=hexToRgba(config.tpoColorPOC,0.90);offscreenCtx.fillText('',labelX,pocY+4);}
      offscreenCtx.restore();
    }
    // Post-session extensions
    const sessionEndTime=profile.sessionEndTime;
    let postHigh=-Infinity,postLow=Infinity;
    for(let ci=displayCandles.length-1;ci>=0;ci--){const c=displayCandles[ci];if(c.time<=sessionEndTime)break;if(c.high>postHigh)postHigh=c.high;if(c.low<postLow)postLow=c.low;}
    if(postHigh===-Infinity)postHigh=currentPrice;if(postLow===Infinity)postLow=currentPrice;
    const lastCd=displayCandles[displayCandles.length-1];
    const curX=lastCd?(timeScale.timeToCoordinate(lastCd.time)??cssWidth-80):cssWidth-80;
    const lineEnd=Math.min(curX+20,cssWidth-80),lineStart=anchorX+profile.maxBlocks*blockW;
    if(lineStart<lineEnd){
      const drawExtLine=(price,set,postVal,comp)=>{
        set.forEach(p=>{
          if(comp(postVal,p))return;
          const y=mainSeries.priceToCoordinate(p+tickSize*0.5);
          if(y===null||y<0||y>candleBottomY)return;
          offscreenCtx.save();offscreenCtx.strokeStyle=config.tpoColorSingle;offscreenCtx.lineWidth=1.2;
          offscreenCtx.globalAlpha=0.70;offscreenCtx.setLineDash([4,5]);
          offscreenCtx.beginPath();offscreenCtx.moveTo(lineStart,y);offscreenCtx.lineTo(lineEnd,y);offscreenCtx.stroke();
          offscreenCtx.setLineDash([]);offscreenCtx.restore();
        });
      };
      drawExtLine(null,profile.topExtremes,postHigh,(post,p)=>post>=p);
      drawExtLine(null,profile.bottomExtremes,postLow,(post,p)=>post<=p+tickSize);
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Indicator System
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class BaseIndicator{
  constructor(id,name,defaultHeight=config.defaultIndicatorHeight){this.id=id;this.name=name;this.height=defaultHeight;this.element=null;this.canvas=null;this.ctx=null;this.offscreenCanvas=null;this.offscreenCtx=null;this.visible=false;}
  createElement(){
    const div=document.createElement('div');div.className='indicator-pane';div.id=`indicator-${this.id}`;div.style.height=this.height+'px';
    div.innerHTML=`<div class="pane-header" data-indicator="${this.id}"><span class="pane-label">${this.name}</span><div class="pane-close" data-indicator="${this.id}">âœ•</div></div><div class="resizer-handle" data-indicator="${this.id}"><div class="resizer-line"></div></div><canvas class="pane-canvas" id="canvas-${this.id}"></canvas>`;
    this.element=div;this.canvas=div.querySelector(`#canvas-${this.id}`);this.ctx=this.canvas.getContext('2d');
    this.offscreenCanvas=document.createElement('canvas');this.offscreenCtx=this.offscreenCanvas.getContext('2d');
    this.setupEventListeners();return div;
  }
  setupEventListeners(){
    this.element.querySelector('.pane-close').addEventListener('click',e=>{e.stopPropagation();findManagerForIndicator(this.id,this.element).removeIndicator(this.id);});
    const resizer=this.element.querySelector('.resizer-handle');let dragging=false,startY=0,startH=0;
    resizer.addEventListener('mousedown',e=>{e.stopPropagation();dragging=true;startY=e.clientY;startH=this.height;document.body.style.cursor='ns-resize';});
    window.addEventListener('mousemove',e=>{if(!dragging)return;this.height=Math.max(MIN_PANE_HEIGHT,startH+(startY-e.clientY));findManagerForIndicator(this.id,this.element).updateLayout();});
    window.addEventListener('mouseup',()=>{if(dragging){dragging=false;document.body.style.cursor='';}});
    this.element.querySelector('.pane-header').addEventListener('mousedown',e=>{if(e.target.classList.contains('pane-close'))return;findManagerForIndicator(this.id,this.element).startDrag(this.id,e);});
  }
  setupBuffers(width,height){
    const dpr=window.devicePixelRatio||1;
    this.canvas.width=Math.floor(width*dpr);this.canvas.height=Math.floor(height*dpr);
    this.canvas.style.width=width+'px';this.canvas.style.height=height+'px';
    this.offscreenCanvas.width=this.canvas.width;this.offscreenCanvas.height=this.canvas.height;
    this.offscreenCtx.setTransform(dpr,0,0,dpr,0,0);this.ctx.setTransform(1,0,0,1,0,0);
  }
  show(){this.visible=true;}hide(){this.visible=false;}draw(){}
  render(){
    if(!this.visible||!this.ctx||!this.offscreenCanvas)return;
    this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);this.ctx.drawImage(this.offscreenCanvas,0,0);
  }
}

class OIIndicator extends BaseIndicator{
  constructor(){super('oi','Open Interest',200);}
  draw(cssWidth){
    if(!this.visible||!this.offscreenCtx)return;
    const ctxS=this.offscreenCtx,drawWidth=cssWidth-measuredPriceScaleWidth;
    ctxS.clearRect(0,0,cssWidth,this.height);
    const barSpacing=chart.timeScale().options().barSpacing,vc=getVisibleCandles(cssWidth);
    let minOI=Infinity,maxOI=-Infinity;
    vc.forEach(({candle:c,x})=>{if(x>drawWidth||!c.oiClose||c.oiClose<=0)return;const h=c.oiHigh||Math.max(c.oiOpen,c.oiClose),l=c.oiLow||Math.min(c.oiOpen,c.oiClose);if(h>maxOI)maxOI=h;if(l<minOI&&l>0)minOI=l;});
    if(maxOI===-Infinity||minOI===Infinity){minOI=0;maxOI=100;}if(minOI===maxOI){minOI*=0.99;maxOI*=1.01;}
    const oP=config.indicatorPadding,aH=this.height-oP*2,oiR=maxOI-minOI;
    const getY=v=>v<=0?this.height-oP:oP+aH*(1-(v-minOI)/oiR);
    vc.forEach(({candle:c,x})=>{
      if(x>drawWidth||!c.oiClose||c.oiClose<=0)return;
      const cO=c.oiOpen||c.oiClose,cC=c.oiClose,cH=c.oiHigh||Math.max(cO,cC),cL=c.oiLow||Math.min(cO,cC);
      const isUp=cC>=cO,color=hexToRgba(isUp?config.oiUpColor:config.oiDownColor,config.oiOpacity),w=Math.max(3,barSpacing*config.oiCandleWidth);
      ctxS.strokeStyle=color;ctxS.lineWidth=1;ctxS.beginPath();ctxS.moveTo(x,getY(cH));ctxS.lineTo(x,getY(cL));ctxS.stroke();
      const bT=Math.min(getY(cO),getY(cC)),bH=Math.max(1,Math.abs(getY(cC)-getY(cO)));
      ctxS.fillStyle=color;ctxS.fillRect(x-w/2,bT,w,bH);
      ctxS.strokeStyle=config.oiBorderColor;ctxS.lineWidth=1;ctxS.strokeRect(x-w/2,bT,w,bH);
    });
  }
}

class CVDIndicator extends BaseIndicator{
  constructor(){super('cvd','Cumulative Volume Delta',150);}
  draw(cssWidth){
    if(!this.visible||!this.offscreenCtx)return;
    const ctxS=this.offscreenCtx,drawWidth=cssWidth-measuredPriceScaleWidth;
    ctxS.clearRect(0,0,cssWidth,this.height);
    const cvdData=[];let cumDelta=0;
    displayCandles.forEach(c=>{const b=displayClusters[String(Math.floor(c.time))];if(b){let d=0;Object.values(b).forEach(v=>d+=v.buy-v.sell);cumDelta+=d;}cvdData.push({time:c.time,cvd:cumDelta});});
    if(!cvdData.length)return;
    const vc=getVisibleCandles(cssWidth);if(!vc.length)return;
    const cvdMap=new Map(cvdData.map(d=>[d.time,d.cvd]));
    let minC=Infinity,maxC=-Infinity;
    vc.forEach(({candle:c})=>{const v=cvdMap.get(c.time);if(v!==undefined){if(v<minC)minC=v;if(v>maxC)maxC=v;}});
    if(minC===Infinity||maxC===-Infinity)return;if(minC===maxC){minC-=1e6;maxC+=1e6;}
    const pad=config.indicatorPadding,aH=this.height-pad*2,range=maxC-minC;
    const getY=v=>pad+(aH*(1-(v-minC)/range));
    if(minC<=0&&maxC>=0){const zy=getY(0);ctxS.strokeStyle='#3a3f4e';ctxS.lineWidth=1;ctxS.setLineDash([4,4]);ctxS.beginPath();ctxS.moveTo(0,zy);ctxS.lineTo(drawWidth,zy);ctxS.stroke();ctxS.setLineDash([]);}
    ctxS.beginPath();let first=true;
    vc.forEach(({candle:c,x})=>{const v=cvdMap.get(c.time);if(v===undefined||x>drawWidth)return;const y=getY(v);if(first){ctxS.moveTo(x,y);first=false;}else ctxS.lineTo(x,y);});
    const fCVD=cvdData[cvdData.length-1]?.cvd||0;
    const lineColor=(config.cvdLineColor&&config.cvdLineColor!=='auto')?config.cvdLineColor:(fCVD>=0?config.upColor:config.downColor);
    ctxS.strokeStyle=lineColor;ctxS.lineWidth=config.cvdLineThickness;ctxS.stroke();
    ctxS.font=`10px ${config.statsFontFamily}`;ctxS.textAlign='right';ctxS.fillStyle='#8b92a7';
    ctxS.fillText(formatUSD(maxC),drawWidth-5,getY(maxC)+12);ctxS.fillText(formatUSD(minC),drawWidth-5,getY(minC)-5);
    const lastV=vc[vc.length-1];const lastX=lastV&&lastV.x<drawWidth?lastV.x:drawWidth-80;
    ctxS.fillStyle=lineColor;ctxS.font=`bold 11px ${config.statsFontFamily}`;ctxS.textAlign='left';ctxS.fillText(formatUSD(fCVD),lastX+10,getY(fCVD)+4);
  }
}

class BarStatsIndicator extends BaseIndicator{
  constructor(){super('barstats','Bar Statistics',72);}
  draw(cssWidth){
    if(!this.visible||!this.offscreenCtx)return;
    const ctxS=this.offscreenCtx,drawWidth=cssWidth-measuredPriceScaleWidth;
    ctxS.clearRect(0,0,cssWidth,this.height);ctxS.save();ctxS.beginPath();ctxS.rect(0,0,drawWidth,this.height);ctxS.clip();
    const vc=getVisibleCandles(cssWidth);if(!vc.length)return;
    const bs=chart.timeScale().options().barSpacing,cw=Math.max(bs*0.92,6);
    const stats=vc.map(({candle:c,x})=>{const b=displayClusters[String(Math.floor(c.time))];let buy=0,sell=0;if(b)Object.values(b).forEach(d=>{buy+=d.buy;sell+=d.sell;});return{x,totalVol:buy+sell,delta:buy-sell};});
    const maxVol=Math.max(...stats.map(s=>s.totalVol),1),maxDelta=Math.max(...stats.map(s=>Math.abs(s.delta)),1);
    const ROW_H=this.height/2,fs=Math.max(8,Math.min(config.cellFontSize,Math.floor(cw*0.32)));
    ctxS.fillStyle=config.bgColor;ctxS.fillRect(0,0,drawWidth,this.height);
    let lineEndX=0;
    stats.forEach(({x,totalVol,delta})=>{
      if(x>drawWidth)return;lineEndX=Math.min(x+cw/2,drawWidth);
      const vR=totalVol/maxVol,dR=Math.abs(delta)/maxDelta,isPos=delta>=0,cL=x-cw/2;
      ctxS.fillStyle=hexToRgba(config.barStatsUpColor,0.08+vR*0.65);ctxS.fillRect(cL,0,cw,ROW_H);
      ctxS.fillStyle=hexToRgba(isPos?config.barStatsUpColor:config.barStatsDownColor,0.08+dR*0.78);ctxS.fillRect(cL,ROW_H,cw,ROW_H);
      ctxS.strokeStyle='rgba(26,31,46,0.35)';ctxS.lineWidth=0.5;ctxS.beginPath();ctxS.moveTo(cL,0);ctxS.lineTo(cL,this.height);ctxS.stroke();
      if(cw>=28){ctxS.textAlign='center';ctxS.textBaseline='middle';ctxS.font=`${config.cellFontWeight} ${fs}px ${config.statsFontFamily}`;ctxS.fillStyle='rgba(232,234,237,0.92)';ctxS.fillText(formatUSD(totalVol),x,ROW_H/2);ctxS.fillText(formatUSD(delta),x,ROW_H*1.5);}
    });
    if(lineEndX>0){ctxS.strokeStyle='rgba(26,31,46,0.7)';ctxS.lineWidth=1;ctxS.beginPath();ctxS.moveTo(0,ROW_H);ctxS.lineTo(lineEndX,ROW_H);ctxS.stroke();}
    ctxS.restore();
  }
}

class VWAPIndicator extends BaseIndicator{constructor(){super('vwap','VWAP',0);}draw(){}}

let vwapData=[],vwapCacheKey='';
function calculateVWAP(){
  vwapData=[];const now=new Date();
  const ss=Math.floor(new Date(Date.UTC(now.getUTCFullYear(),now.getUTCMonth(),now.getUTCDate())).getTime()/1000);
  let pv=0,vol=0;
  displayCandles.forEach(c=>{if(c.time<ss)return;const bv=c.volume||0;if(!bv)return;const tp=(c.high+c.low+c.close)/3;pv+=tp*bv;vol+=bv;vwapData.push({time:c.time,vwap:vol>0?pv/vol:tp});});
}
function drawVWAP(cssWidth,candleBottomY){
  if(!config.vwapVisible)return;
  const lastC=displayCandles[displayCandles.length-1];
  const ck=`${displayCandles.length}_${lastC?.time??0}_${lastC?.volume??0}_${lastC?.high??0}_${lastC?.low??0}`;
  if(ck!==vwapCacheKey){calculateVWAP();vwapCacheKey=ck;}
  if(!vwapData.length)return;
  const ts=chart.timeScale(),drawWidth=cssWidth-measuredPriceScaleWidth;
  offscreenCtx.save();offscreenCtx.strokeStyle=config.vwapColor;offscreenCtx.lineWidth=1;
  offscreenCtx.setLineDash(getLineDash(config.vwapLineStyle));offscreenCtx.globalAlpha=0.85;
  offscreenCtx.beginPath();let fp=true;
  vwapData.forEach(pt=>{const x=ts.timeToCoordinate(pt.time);if(x===null||x<-100||x>drawWidth)return;const y=mainSeries.priceToCoordinate(pt.vwap);if(y===null||y<0||y>candleBottomY)return;if(fp){offscreenCtx.moveTo(x,y);fp=false;}else offscreenCtx.lineTo(x,y);});
  offscreenCtx.stroke();offscreenCtx.setLineDash([]);
  if(vwapData.length&&(config.vwapShowLabel||config.vwapShowPrice)){
    const last=vwapData[vwapData.length-1],lx=ts.timeToCoordinate(last.time),ly=mainSeries.priceToCoordinate(last.vwap);
    if(lx!==null&&ly!==null&&ly>=0&&ly<=candleBottomY){
      let text=(config.vwapShowLabel?'VWAP':'')+(config.vwapShowLabel&&config.vwapShowPrice?' ':'')+( config.vwapShowPrice?last.vwap.toFixed(2):'');
      if(text){offscreenCtx.font="bold 10px 'JetBrains Mono',monospace";offscreenCtx.fillStyle=config.vwapColor;offscreenCtx.textAlign='left';offscreenCtx.globalAlpha=0.9;offscreenCtx.fillText(text,lx+8,ly+4);}
    }
  }
  offscreenCtx.restore();
}

function findManagerForIndicator(id,element){
  if(element){if(indicatorManager.container&&indicatorManager.container.contains(element))return indicatorManager;for(const p of extraPanels)if(p.indicatorManager.container.contains(element))return p.indicatorManager;}
  if(indicatorManager.indicators.has(id))return indicatorManager;
  for(const p of extraPanels)if(p.indicatorManager.indicators.has(id))return p.indicatorManager;
  return indicatorManager;
}

class IndicatorManager{
  constructor(){this.indicators=new Map();this.order=[];this.container=null;this.dragState=null;this.placeholder=null;this.chart=null;this.wrapper=null;this.onLayout=null;}
  addIndicator(ind){if(this.indicators.has(ind.id))return;this.container.appendChild(ind.createElement());this.indicators.set(ind.id,ind);this.order.push(ind.id);ind.show();this.updateLayout();}
  removeIndicator(id){const ind=this.indicators.get(id);if(!ind)return;ind.hide();ind.element.remove();this.indicators.delete(id);this.order=this.order.filter(i=>i!==id);this.updateLayout();const btn=document.getElementById(`toggle-${id}`);if(btn)btn.classList.remove('active');}
  getIndicator(id){return this.indicators.get(id);}
  updateLayout(){
    const ac=this.chart||chart,wr=this.wrapper||activeWrapperEl||document.getElementById('panel-wrapper-0');
    if(!wr||wr.clientWidth===0)return;
    const totalH=wr.clientHeight;let totalIH=0;
    this.order.forEach(id=>{const ind=this.indicators.get(id);if(ind&&ind.visible)totalIH+=ind.height;});
    const mPct=Math.min(0.92,(totalIH+TIME_AXIS_HEIGHT)/totalH);
    ac.priceScale('right').applyOptions({scaleMargins:{top:0.05,bottom:mPct}});
    let curBottom=TIME_AXIS_HEIGHT;
    this.order.forEach(id=>{const ind=this.indicators.get(id);if(!ind||!ind.visible)return;ind.element.style.bottom=curBottom+'px';ind.element.style.height=ind.height+'px';ind.setupBuffers(wr.clientWidth,ind.height);curBottom+=ind.height;});
    let gapCover=wr.querySelector('.ind-gap-cover');
    if(totalIH>0){
      if(!gapCover){gapCover=document.createElement('div');gapCover.className='ind-gap-cover';gapCover.style.cssText=`position:absolute;left:0;right:0;bottom:${TIME_AXIS_HEIGHT-1}px;height:4px;background:rgba(10,14,26,.98);z-index:29;pointer-events:none;`;wr.appendChild(gapCover);}
      gapCover.style.display='block';
    }else if(gapCover){gapCover.style.display='none';}
    ac.applyOptions({width:wr.clientWidth,height:totalH});updatePaneRight();
    if(this.onLayout)this.onLayout();else if(typeof scheduleDraw==='function')scheduleDraw();
  }
  startDrag(id,e){
    const ind=this.indicators.get(id);if(!ind)return;
    this.dragState={id,startY:e.clientY,startOrder:[...this.order]};ind.element.classList.add('dragging');
    this.placeholder=document.createElement('div');this.placeholder.className='drag-placeholder';this.placeholder.style.height='2px';
    (this.wrapper||document.getElementById('panel-wrapper-0')).appendChild(this.placeholder);
    document.addEventListener('mousemove',this.handleDragMove);document.addEventListener('mouseup',this.handleDragEnd);
  }
  handleDragMove=(e)=>{
    if(!this.dragState){document.removeEventListener('mousemove',this.handleDragMove);document.removeEventListener('mouseup',this.handleDragEnd);return;}
    const wr=this.wrapper||document.getElementById('panel-wrapper-0');
    const relY=wr.getBoundingClientRect().bottom-e.clientY;let insertIdx=0,cumH=TIME_AXIS_HEIGHT;
    for(let i=0;i<this.order.length;i++){const ind=this.indicators.get(this.order[i]);if(!ind||ind.id===this.dragState.id)continue;if(relY>cumH+ind.height/2)insertIdx=i+1;cumH+=ind.height;}
    let phBottom=TIME_AXIS_HEIGHT;for(let i=0;i<insertIdx;i++){const ind=this.indicators.get(this.order[i]);if(ind&&ind.id!==this.dragState.id)phBottom+=ind.height;}
    this.placeholder.style.bottom=phBottom+'px';
  }
  handleDragEnd=()=>{
    if(!this.dragState)return;
    const ind=this.indicators.get(this.dragState.id);if(ind)ind.element.classList.remove('dragging');
    const phBottom=parseInt(this.placeholder.style.bottom);let newOrder=[],cumH=TIME_AXIS_HEIGHT,inserted=false;
    this.order.forEach(id=>{if(id===this.dragState.id)return;const ind=this.indicators.get(id);if(!ind)return;if(!inserted&&cumH>=phBottom){newOrder.push(this.dragState.id);inserted=true;}newOrder.push(id);cumH+=ind.height;});
    if(!inserted)newOrder.push(this.dragState.id);this.order=newOrder;
    if(this.placeholder){this.placeholder.remove();this.placeholder=null;}
    document.removeEventListener('mousemove',this.handleDragMove);document.removeEventListener('mouseup',this.handleDragEnd);
    this.dragState=null;this.updateLayout();
  }
  drawAll(cssWidth){this.indicators.forEach(ind=>{if(ind.visible){ind.draw(cssWidth);ind.render();}});}
}
// â”€â”€ Toggle Event Listeners â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _getActiveMgr(){return selectedPanelId===0?indicatorManager:extraPanels.find(p=>p.id===selectedPanelId)?.indicatorManager;}
function _toggleIndicator(id,BtnId,Cls){
  document.getElementById(BtnId).addEventListener('click',function(){
    const mgr=_getActiveMgr();if(!mgr)return;
    const ind=mgr.getIndicator(id);
    if(ind&&ind.visible){mgr.removeIndicator(id);this.classList.remove('active');}
    else{mgr.addIndicator(new Cls());this.classList.add('active');}
  });
}
_toggleIndicator('oi','toggle-oi',OIIndicator);
_toggleIndicator('cvd','toggle-cvd',CVDIndicator);
_toggleIndicator('barstats','toggle-barstats',BarStatsIndicator);

document.getElementById('toggle-barstats').addEventListener('click',()=>scheduleDraw());

document.getElementById('toggle-dailylevels').addEventListener('click',function(){
  if(selectedPanelId===0){config.showDailyLevels=!config.showDailyLevels;this.classList.toggle('active',config.showDailyLevels);scheduleDraw();}
  else{const p=extraPanels.find(p=>p.id===selectedPanelId);if(p){p.showDailyLevels=!p.showDailyLevels;this.classList.toggle('active',p.showDailyLevels);schedulePanelDraw(p);}}
});
document.getElementById('toggle-tpo').addEventListener('click',function(){
  if(selectedPanelId===0){config.showTPO=!config.showTPO;this.classList.toggle('active',config.showTPO);const sw=document.getElementById('toggle-tpo-switch');if(sw)sw.classList.toggle('active',config.showTPO);tpoCacheKey='';scheduleDraw();}
  else{const p=extraPanels.find(p=>p.id===selectedPanelId);if(p){p.showTPO=!p.showTPO;this.classList.toggle('active',p.showTPO);p.tpoCacheKey='';schedulePanelDraw(p);}}
});
document.getElementById('toggle-vwap').addEventListener('click',function(){
  if(selectedPanelId===0){config.vwapVisible=!config.vwapVisible;this.classList.toggle('active',config.vwapVisible);scheduleDraw();}
  else{const p=extraPanels.find(p=>p.id===selectedPanelId);if(p){p.vwapVisible=!p.vwapVisible;this.classList.toggle('active',p.vwapVisible);schedulePanelDraw(p);}}
});

function getLineDash(style){return style==='solid'?[]:style==='dashed'?[8,4]:style==='dotted'?[2,4]:[4,4];}

// â”€â”€ Context Menu Builders â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _iRow(label,ctrl){
  const row=document.createElement('div');row.style.cssText='display:flex;align-items:center;justify-content:space-between;gap:10px;min-height:26px;';
  const lbl=document.createElement('span');lbl.style.cssText='font-size:10px;color:#8b92a7;text-transform:uppercase;letter-spacing:.04em;white-space:nowrap;flex-shrink:0;';
  lbl.textContent=label;row.appendChild(lbl);row.appendChild(ctrl);return row;
}
function _iDivider(){const d=document.createElement('div');d.style.cssText='height:1px;background:rgba(26,31,46,.8);margin:1px 0;';return d;}
function _iSectionLabel(text){const s=document.createElement('div');s.style.cssText='font-size:9px;color:#5a6178;text-transform:uppercase;letter-spacing:.06em;margin-top:2px;';s.textContent=text;return s;}
function _iColor(value,onChange){
  const wrap=document.createElement('div');wrap.style.cssText='width:54px;height:22px;border-radius:4px;overflow:hidden;border:1px solid #1a1f2e;cursor:pointer;flex-shrink:0;transition:border-color .2s;';
  wrap.onmouseover=()=>wrap.style.borderColor='#3b82f6';wrap.onmouseout=()=>wrap.style.borderColor='#1a1f2e';
  const inp=document.createElement('input');inp.type='color';inp.value=value;inp.style.cssText='border:none;width:200%;height:200%;transform:translate(-25%,-25%);cursor:pointer;background:none;';
  inp.addEventListener('input',e=>onChange(e.target.value));wrap.appendChild(inp);return wrap;
}
function _iSlider(value,min,max,step,fmt,onChange){
  const wrap=document.createElement('div');wrap.style.cssText='display:flex;align-items:center;gap:6px;flex:1;min-width:0;';
  const inp=document.createElement('input');inp.type='range';inp.min=min;inp.max=max;inp.step=step;inp.value=value;inp.style.cssText='flex:1;min-width:0;';
  const val=document.createElement('span');val.style.cssText='font-size:10px;color:#3b82f6;min-width:36px;text-align:right;flex-shrink:0;';val.textContent=fmt(value);
  inp.addEventListener('input',e=>{val.textContent=fmt(e.target.value);onChange(parseFloat(e.target.value));});wrap.appendChild(inp);wrap.appendChild(val);return wrap;
}
function _iSelect(options,value,onChange){
  const sel=document.createElement('select');sel.style.cssText='background:#0a0e1a;border:1px solid #1a1f2e;color:#e8eaed;font-family:"JetBrains Mono",monospace;font-size:10px;border-radius:4px;padding:3px 6px;cursor:pointer;flex-shrink:0;';
  options.forEach(o=>{const opt=document.createElement('option');opt.value=o.v;opt.textContent=o.l;if(o.v===value)opt.selected=true;sel.appendChild(opt);});
  sel.addEventListener('change',e=>onChange(e.target.value));return sel;
}
function _iToggle(checked,onChange){
  const sw=document.createElement('div');sw.style.cssText=`width:36px;height:20px;background:${checked?'#3b82f6':'#1a1f2e'};border-radius:10px;cursor:pointer;position:relative;transition:background .2s;flex-shrink:0;`;
  const knob=document.createElement('div');knob.style.cssText=`position:absolute;top:2px;left:${checked?'16':'2'}px;width:16px;height:16px;background:#fff;border-radius:50%;transition:left .2s;box-shadow:0 1px 3px rgba(0,0,0,.3);`;
  sw.appendChild(knob);let state=checked;
  sw.addEventListener('click',()=>{state=!state;sw.style.background=state?'#3b82f6':'#1a1f2e';knob.style.left=state?'16px':'2px';onChange(state);});return sw;
}
function getIC(){return selectedPanelId===0?config:extraPanels.find(p=>p.id===selectedPanelId)||config;}
function invalidateTpoCache(){if(selectedPanelId===0){tpoCacheKey='';}else{const p=extraPanels.find(p=>p.id===selectedPanelId);if(p)p.tpoCacheKey='';}}

function _menuOI(body){
  const ic=getIC();
  body.appendChild(_iRow('Up Color',_iColor(ic.oiUpColor,v=>{getIC().oiUpColor=v;scheduleDraw();})));
  body.appendChild(_iRow('Down Color',_iColor(ic.oiDownColor,v=>{getIC().oiDownColor=v;scheduleDraw();})));
  body.appendChild(_iRow('Border Color',_iColor(ic.oiBorderColor,v=>{getIC().oiBorderColor=v;scheduleDraw();})));
  body.appendChild(_iRow('Opacity',_iSlider(Math.round(ic.oiOpacity*100),10,100,5,v=>v+'%',v=>{getIC().oiOpacity=v/100;scheduleDraw();})));
}
function _menuCVD(body){
  const ic=getIC(),isAuto=ic.cvdLineColor==='auto';
  body.appendChild(_iSectionLabel('Line Color'));
  const colorWrap=document.createElement('div');colorWrap.style.cssText=`opacity:${isAuto?.3:1};pointer-events:${isAuto?'none':'auto'};`;
  body.appendChild(_iRow('Auto (up/down)',_iToggle(isAuto,on=>{getIC().cvdLineColor=on?'auto':'#3b82f6';colorWrap.style.opacity=on?.3:1;colorWrap.style.pointerEvents=on?'none':'auto';scheduleDraw();})));
  colorWrap.appendChild(_iColor(isAuto?'#3b82f6':ic.cvdLineColor,v=>{if(getIC().cvdLineColor!=='auto'){getIC().cvdLineColor=v;scheduleDraw();}}));
  body.appendChild(_iRow('Custom Color',colorWrap));body.appendChild(_iDivider());
  body.appendChild(_iRow('Thickness',_iSlider(ic.cvdLineThickness,1,5,.5,v=>v+'px',v=>{getIC().cvdLineThickness=v;scheduleDraw();})));
}
function _menuBarStats(body){
  const ic=getIC();
  body.appendChild(_iRow('Positive Color',_iColor(ic.barStatsUpColor,v=>{getIC().barStatsUpColor=v;scheduleDraw();})));
  body.appendChild(_iRow('Negative Color',_iColor(ic.barStatsDownColor,v=>{getIC().barStatsDownColor=v;scheduleDraw();})));
}
function _menuTPO(body){
  const ic=getIC();
  body.appendChild(_iRow('Tick Size ($)',_iSlider(ic.tpoTickSize,10,500,10,v=>'$'+v,v=>{getIC().tpoTickSize=v;invalidateTpoCache();scheduleDraw();})));
  body.appendChild(_iRow('Block Width',_iSlider(ic.tpoBlockWidth,3,24,1,v=>v+'px',v=>{getIC().tpoBlockWidth=v;scheduleDraw();})));
  body.appendChild(_iDivider());body.appendChild(_iSectionLabel('Opacity'));
  body.appendChild(_iRow('Value Area',_iSlider(Math.round(ic.tpoOpacityVA*100),10,100,5,v=>v+'%',v=>{getIC().tpoOpacityVA=v/100;scheduleDraw();})));
  body.appendChild(_iRow('Non-VA',_iSlider(Math.round(ic.tpoOpacityNonVA*100),5,80,5,v=>v+'%',v=>{getIC().tpoOpacityNonVA=v/100;scheduleDraw();})));
  body.appendChild(_iDivider());body.appendChild(_iSectionLabel('Colors'));
  [['Value Area','tpoColorVA'],['Non-VA','tpoColorNonVA'],['Single Print','tpoColorSingle'],['POC Border','tpoColorPOC']].forEach(([label,key])=>{
    body.appendChild(_iRow(label,_iColor(ic[key],v=>{getIC()[key]=v;scheduleDraw();})));
  });
}
function _menuVWAP(body){
  const ic=getIC();
  body.appendChild(_iRow('Color',_iColor(ic.vwapColor,v=>{getIC().vwapColor=v;scheduleDraw();})));
  body.appendChild(_iRow('Line Style',_iSelect([{v:'solid',l:'â”€â”€â”€â”€ Solid'},{v:'dashed',l:'- - - Dashed'},{v:'dotted',l:'Â·Â·Â· Dotted'}],ic.vwapLineStyle,v=>{getIC().vwapLineStyle=v;scheduleDraw();})));
  body.appendChild(_iDivider());body.appendChild(_iSectionLabel('Labels'));
  body.appendChild(_iRow('Show "VWAP"',_iToggle(ic.vwapShowLabel,v=>{getIC().vwapShowLabel=v;scheduleDraw();})));
  body.appendChild(_iRow('Show Price',_iToggle(ic.vwapShowPrice,v=>{getIC().vwapShowPrice=v;scheduleDraw();})));
}
function _menuLevels(body){
  const ic=getIC();
  body.appendChild(_iRow('Color',_iColor(ic.levelsColor,v=>{getIC().levelsColor=v;scheduleDraw();})));
  body.appendChild(_iRow('Line Style',_iSelect([{v:'solid',l:'â”€â”€â”€â”€ Solid'},{v:'dashed',l:'- - - Dashed'},{v:'dotted',l:'Â·Â·Â· Dotted'}],ic.levelsLineStyle,v=>{getIC().levelsLineStyle=v;scheduleDraw();})));
  body.appendChild(_iDivider());body.appendChild(_iSectionLabel('Visible Levels'));
  const LABELS={dOpen:'Day Open',dHigh:'Day High',dLow:'Day Low',dEQ:'Day EQ',pdHigh:'Prev High',pdLow:'Prev Low',pdEQ:'Prev EQ'};
  Object.entries(LABELS).forEach(([key,label])=>{body.appendChild(_iRow(label,_iToggle(ic.levelsEnabled[key],v=>{getIC().levelsEnabled[key]=v;scheduleDraw();})));});
}

let _indCtxActive=null;
function showIndicatorCtxMenu(id,anchorEl){
  const menu=document.getElementById('indicator-ctx-menu'),title=document.getElementById('ind-ctx-title'),body=document.getElementById('ind-ctx-body');
  const NAMES={oi:'Open Interest',cvd:'Volume Delta',barstats:'Bar Statistics',tpo:'TPO / Market Profile',vwap:'VWAP',dailylevels:'Key Levels'};
  title.textContent=NAMES[id]||id;body.innerHTML='';
  ({oi:_menuOI,cvd:_menuCVD,barstats:_menuBarStats,tpo:_menuTPO,vwap:_menuVWAP,dailylevels:_menuLevels})[id]?.(body);
  _indCtxActive=id;menu.style.display='block';
  const rect=anchorEl.getBoundingClientRect(),mw=menu.offsetWidth||252,mh=menu.offsetHeight||300;
  let left=rect.left,top=rect.bottom+6;
  if(left+mw>window.innerWidth-8)left=window.innerWidth-mw-8;
  if(top+mh>window.innerHeight-8)top=rect.top-mh-6;
  menu.style.left=left+'px';menu.style.top=top+'px';
}
function hideIndicatorCtxMenu(){document.getElementById('indicator-ctx-menu').style.display='none';_indCtxActive=null;}

['oi','cvd','barstats','tpo','vwap','dailylevels'].forEach(id=>{
  const btn=document.getElementById(`toggle-${id}`);if(!btn)return;
  btn.addEventListener('contextmenu',e=>{e.preventDefault();e.stopPropagation();showIndicatorCtxMenu(id,btn);});
});
document.addEventListener('mousedown',e=>{const m=document.getElementById('indicator-ctx-menu');if(m&&m.style.display!=='none'&&!m.contains(e.target))hideIndicatorCtxMenu();});
document.getElementById('ind-ctx-close').addEventListener('click',hideIndicatorCtxMenu);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Core Drawing
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function hexToRgba(hex,alpha){
  if(!hex||hex.length<7)return`rgba(100,100,100,${alpha})`;
  const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
  return`rgba(${r},${g},${b},${alpha})`;
}
function calculateCellOpacity(v){
  if(v<50000)return 0.10;if(v<250000)return 0.40+(v-50000)/200000*0.20;
  if(v<1000000)return 0.60+(v-250000)/750000*0.10;if(v<1200000)return 0.70+(v-1000000)/200000*0.30;return 1.0;
}
function createSeries(type){
  if(mainSeries){try{chart.removeSeries(mainSeries);}catch(e){}mainSeries=null;}
  const opts={upColor:'rgba(0,0,0,0)',downColor:'rgba(0,0,0,0)',borderVisible:false,wickUpColor:'rgba(0,0,0,0)',wickDownColor:'rgba(0,0,0,0)',priceLineVisible:config.showPriceLine,lastValueVisible:false,priceLineColor:config.upColor,priceLineWidth:1,priceLineStyle:2};
  mainSeries=type==='candle'?chart.addCandlestickSeries(opts):chart.addBarSeries(opts);return mainSeries;
}
function updateCandleAppearance(){
  const lc=displayCandles[displayCandles.length-1],lColor=(lc&&lc.close>=lc.open)?config.upColor:config.downColor;
  mainSeries.applyOptions({upColor:'rgba(0,0,0,0)',downColor:'rgba(0,0,0,0)',wickUpColor:'rgba(0,0,0,0)',wickDownColor:'rgba(0,0,0,0)',priceLineVisible:config.showPriceLine,lastValueVisible:false,priceLineColor:lColor,priceLineWidth:1,priceLineStyle:2});
}
function setupBuffersForSize(){
  if(!activeWrapperEl)return;
  const dpr=window.devicePixelRatio||1,w=activeWrapperEl.clientWidth,h=activeWrapperEl.clientHeight;
  chartOverlayCanvas.width=Math.floor(w*dpr);chartOverlayCanvas.height=Math.floor(h*dpr);
  chartOverlayCanvas.style.width=w+'px';chartOverlayCanvas.style.height=h+'px';
  offscreenCanvas.width=chartOverlayCanvas.width;offscreenCanvas.height=chartOverlayCanvas.height;
  offscreenCtx.setTransform(dpr,0,0,dpr,0,0);ctxOverlay.setTransform(1,0,0,1,0,0);
}
function formatUSD(val){
  if(val===0)return'0';const abs=Math.abs(val);
  if(abs>=1e6)return(val/1e6).toFixed(1)+'M';if(abs>=1000)return(val/1000).toFixed(0)+'K';return Math.round(val).toString();
}
function upsertCandle(tsSec,o,h,l,c,v=0){
  if(!base5mCandles)base5mCandles=[];
  const key=Math.floor(tsSec);let found=false;
  for(let i=base5mCandles.length-1;i>=0;i--){if(Math.floor(base5mCandles[i].time)===key){base5mCandles[i].open=o;base5mCandles[i].high=h;base5mCandles[i].low=l;base5mCandles[i].close=c;base5mCandles[i].volume=v;found=true;break;}}
  if(!found){
    const prevOI=base5mCandles.length>0?(base5mCandles[base5mCandles.length-1].oiClose||0):0;
    base5mCandles.push({time:key,open:o,high:h,low:l,close:c,volume:v,oiOpen:prevOI,oiHigh:prevOI,oiLow:prevOI,oiClose:prevOI});
    base5mCandles.sort((a,b)=>a.time-b.time);
    const MAX=1500;if(base5mCandles.length>MAX){const pruned=base5mCandles.splice(0,base5mCandles.length-MAX);pruned.forEach(c=>delete base5mClusters[String(c.time)]);}
  }
}
function getDynamicTickSize(baseTick,minPx){
  const y1=mainSeries.priceToCoordinate(currentPrice),y2=mainSeries.priceToCoordinate(currentPrice+baseTick);
  if(y1===null||y2===null)return baseTick*2;
  const pxPer=Math.abs(y1-y2);
  for(const m of[1,2,3,4,5,6,7,8,9,10,12,14,16,18,20,25,30,40,50,60,80,100,200])if(pxPer*m>=minPx)return baseTick*m;
  return baseTick*500;
}
function updateCustomPriceLabel(){
  if(!config.showPriceLabel||!mainSeries||!currentPrice||!activePriceLabelEl){if(activePriceLabelEl)activePriceLabelEl.style.display='none';return;}
  const yCoord=mainSeries.priceToCoordinate(currentPrice);if(yCoord===null){activePriceLabelEl.style.display='none';return;}
  const mB=chart.priceScale('right').options().scaleMargins.bottom,cbY=activeWrapperEl.clientHeight*(1-mB);
  if(yCoord<0||yCoord>cbY){activePriceLabelEl.style.display='none';return;}
  const lc=displayCandles[displayCandles.length-1],isUp=lc?(lc.close>=lc.open):true,color=isUp?config.upColor:config.downColor;
  activePriceLabelEl.style.cssText=`display:flex;align-items:center;gap:1px;position:absolute;right:0;z-index:40;pointer-events:none;top:${yCoord-13}px;font-family:${config.statsFontFamily};font-size:${config.priceLabelFontSize}px;`;
  const priceText=currentPrice.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
  const nowSec=Math.floor(Date.now()/1000),barSec=getBarSeconds(config.displayTimeframe),diff=(lastBarTime+barSec)-nowSec;
  const timerStr=diff>0?formatTime(diff):'0:00';
  activePriceLabelEl.innerHTML=`<div class="price-label-box" style="background:${hexToRgba(color,.85)};color:#fff;font-size:${config.priceLabelFontSize}px;align-items:center;"><span style="font-weight:700;letter-spacing:.01em;line-height:1.2;">${priceText}</span>${config.showCountdown?`<span style="font-size:${config.timerFontSize}px;opacity:.88;line-height:1.2;text-align:center;width:100%;">${timerStr}</span>`:''}</div>`;
}

function drawDailyLevels(cssWidth,candleBottomY){
  if(!config.showDailyLevels||!displayCandles||!displayCandles.length)return;
  const drawWidth=cssWidth-measuredPriceScaleWidth,ts=chart.timeScale();
  const now=new Date(),todayStart=Math.floor(new Date(Date.UTC(now.getUTCFullYear(),now.getUTCMonth(),now.getUTCDate())).getTime()/1000);
  const yestStart=todayStart-86400;
  let dOpen=null,dHigh=-Infinity,dLow=Infinity,pdHigh=-Infinity,pdLow=Infinity;
  displayCandles.forEach(c=>{
    if(c.time>=todayStart){if(dOpen===null)dOpen=c.open;if(c.high>dHigh)dHigh=c.high;if(c.low<dLow)dLow=c.low;}
    else if(c.time>=yestStart){if(c.high>pdHigh)pdHigh=c.high;if(c.low<pdLow)pdLow=c.low;}
  });
  const dEQ=(dHigh>-Infinity&&dLow<Infinity)?(dHigh+dLow)/2:null;
  const pdEQ=(pdHigh>-Infinity&&pdLow<Infinity)?(pdHigh+pdLow)/2:null;
  const todayFC=displayCandles.find(c=>c.time>=todayStart),todayX=todayFC?(ts.timeToCoordinate(todayFC.time)??0):0;
  const pdFC=displayCandles.find(c=>c.time>=yestStart&&c.time<todayStart),pdX=pdFC?(ts.timeToCoordinate(pdFC.time)??0):0;
  const levels=[
    {value:dOpen,label:'dOpen',startX:todayX},{value:dHigh>-Infinity?dHigh:null,label:'dHigh',startX:todayX},
    {value:dLow<Infinity?dLow:null,label:'dLow',startX:todayX},{value:dEQ,label:'dEQ',startX:todayX},
    {value:pdHigh>-Infinity?pdHigh:null,label:'pdHigh',startX:pdX},{value:pdLow<Infinity?pdLow:null,label:'pdLow',startX:pdX},{value:pdEQ,label:'pdEQ',startX:pdX},
  ];
  offscreenCtx.save();offscreenCtx.font="600 9px 'JetBrains Mono',monospace";offscreenCtx.textBaseline='middle';offscreenCtx.lineWidth=1;
  offscreenCtx.strokeStyle=hexToRgba(config.levelsColor,.75);offscreenCtx.fillStyle=hexToRgba(config.levelsColor,.92);
  const dash=getLineDash(config.levelsLineStyle),GAP=6;
  levels.forEach(({value,label,startX})=>{
    if(!config.levelsEnabled[label]||value===null||value===undefined)return;
    const y=mainSeries.priceToCoordinate(value);if(y===null||y<0||y>candleBottomY)return;
    const lineStart=Math.max(0,startX);if(lineStart>=drawWidth)return;
    const lw=offscreenCtx.measureText(label).width,lx=drawWidth-lw-12;if(lx<=lineStart+20)return;
    offscreenCtx.setLineDash(dash);
    offscreenCtx.beginPath();offscreenCtx.moveTo(lineStart,y);offscreenCtx.lineTo(lx-GAP,y);offscreenCtx.stroke();
    offscreenCtx.beginPath();offscreenCtx.moveTo(lx+lw+GAP,y);offscreenCtx.lineTo(drawWidth,y);offscreenCtx.stroke();
    offscreenCtx.setLineDash([]);offscreenCtx.fillText(label,lx,y);
  });
  offscreenCtx.restore();
}

function drawCumulativeCluster(cssWidth,cssHeight,candleBottomY){
  if(config.hideFootprints)return;
  const ts=chart.timeScale(),bs=ts.options().barSpacing,vr=ts.getVisibleLogicalRange();if(!vr)return;
  const rts=getDynamicTickSize(config.baseTickSize,config.minCellHeight),cw=bs*2*0.92;
  let rmX=0,rmT=0;
  for(let i=displayCandles.length-1;i>=0;i--){const c=displayCandles[i],x=ts.timeToCoordinate(c.time);if(x!==null&&x>=0&&x<=cssWidth&&c.time>rmT){rmT=c.time;rmX=x;}}
  if(rmX===0&&displayCandles.length>0){const x=ts.timeToCoordinate(displayCandles[displayCandles.length-1].time);if(x!==null)rmX=x;}
  let clX=rmX+150;if(clX+cw>cssWidth-75)clX=cssWidth-75-cw;if(clX<0)return;
  let aggData={},totalBuy=0,totalSell=0;
  Object.keys(displayClusters).forEach(timestamp=>{
    const tsSec=parseInt(timestamp),x=ts.timeToCoordinate(tsSec);
    if(config.cumulativeMode==='visible'&&(x===null||x<-100||x>cssWidth+100))return;
    Object.keys(displayClusters[timestamp]).forEach(pk=>{
      const price=parseFloat(pk),data=displayClusters[timestamp][pk],ap=Math.floor(price/rts)*rts;
      if(!aggData[ap])aggData[ap]={buy:0,sell:0};aggData[ap].buy+=data.buy;aggData[ap].sell+=data.sell;totalBuy+=data.buy;totalSell+=data.sell;
    });
  });
  if(!Object.keys(aggData).length)return;
  let pocKey=null,pocTotal=-Infinity;Object.keys(aggData).forEach(pk=>{const t=aggData[pk].buy+aggData[pk].sell;if(t>pocTotal){pocTotal=t;pocKey=pk;}});
  let minP=Infinity,maxP=-Infinity;Object.keys(aggData).forEach(pk=>{const p=parseFloat(pk);if(p<minP)minP=p;if(p>maxP)maxP=p;});
  const yTop=mainSeries.priceToCoordinate(maxP+rts),yBot=mainSeries.priceToCoordinate(minP);if(yTop===null||yBot===null)return;
  let ctY,cbY2,cbH,cbY;
  if(config.cumulativeMode==='all'){ctY=yTop;cbY2=yBot;cbH=Math.abs(cbY2-ctY);cbY=Math.min(ctY,cbY2);}
  else{ctY=Math.max(0,Math.min(yTop,candleBottomY));cbY2=Math.max(0,Math.min(yBot,candleBottomY));if(ctY>=candleBottomY)return;cbH=Math.abs(cbY2-ctY);cbY=Math.min(ctY,cbY2);}
  offscreenCtx.fillStyle=hexToRgba(config.panelColor,config.clusterBgOpacity);offscreenCtx.fillRect(clX,cbY,cw,cbH);
  offscreenCtx.strokeStyle='#1a1f2e';offscreenCtx.lineWidth=config.cellBorderWidth;offscreenCtx.strokeRect(clX,cbY,cw,cbH);
  offscreenCtx.font=`${config.cellFontWeight} ${config.cellFontSize}px ${config.statsFontFamily}`;offscreenCtx.textAlign='center';offscreenCtx.textBaseline='middle';
  Object.keys(aggData).forEach(pk=>{
    const pF=parseFloat(pk),data=aggData[pk];
    let cYT=mainSeries.priceToCoordinate(pF+rts),cYB=mainSeries.priceToCoordinate(pF);if(cYT===null||cYB===null)return;
    if(config.cumulativeMode==='visible'){cYT=Math.max(0,Math.min(cYT,candleBottomY));cYB=Math.max(0,Math.min(cYB,candleBottomY));if(cYT>=candleBottomY)return;}
    const hC=Math.abs(cYB-cYT),dY=Math.min(cYT,cYB),delta=data.buy-data.sell,total=data.buy+data.sell;
    offscreenCtx.fillStyle=hexToRgba(delta>=0?config.upColor:config.downColor,calculateCellOpacity(total));offscreenCtx.fillRect(clX,dY,cw,hC);
    if(String(pk)===String(pocKey)){offscreenCtx.strokeStyle=config.pocColor;offscreenCtx.lineWidth=config.pocBorderWidth;offscreenCtx.strokeRect(clX,dY,cw,hC);}
    if(hC>14){offscreenCtx.fillStyle='#fff';offscreenCtx.fillText(formatUSD(delta),clX+cw/2,dY+hC/2);}
  });
  const totalDelta=totalBuy-totalSell,statsY=cbY-25;
  if(config.cumulativeMode==='all'||(statsY>0&&statsY<candleBottomY)){
    const dc=totalDelta>=0?config.upColor:config.downColor,cx=clX+cw/2;
    offscreenCtx.font=`${config.statsFontWeight} ${config.statsFontSize}px ${config.statsFontFamily}`;offscreenCtx.textAlign='center';
    offscreenCtx.fillStyle='#a6afd3';offscreenCtx.fillText(`V:${formatUSD(totalBuy+totalSell)}`,cx,statsY-8);
    const dv=formatUSD(totalDelta),dW=offscreenCtx.measureText('D:').width,dvW=offscreenCtx.measureText(dv).width;
    offscreenCtx.textAlign='left';offscreenCtx.fillStyle='#a6afd3';offscreenCtx.fillText('D:',cx-(dW+dvW)/2,statsY+8);
    offscreenCtx.fillStyle=dc;offscreenCtx.fillText(dv,cx-(dW+dvW)/2+dW,statsY+8);offscreenCtx.textAlign='center';
  }
}

function syncHeaderButtons(){
  const isMain=selectedPanelId===0,panel=isMain?null:extraPanels.find(p=>p.id===selectedPanelId),mgr=isMain?indicatorManager:panel?.indicatorManager;
  ['oi','cvd','barstats'].forEach(id=>{document.getElementById(`toggle-${id}`).classList.toggle('active',mgr?.getIndicator(id)?.visible??false);});
  const tpoA=isMain?config.showTPO:(panel?.showTPO??false);
  document.getElementById('toggle-tpo').classList.toggle('active',tpoA);const sw=document.getElementById('toggle-tpo-switch');if(sw)sw.classList.toggle('active',tpoA);
  document.getElementById('toggle-vwap').classList.toggle('active',isMain?config.vwapVisible:(panel?.vwapVisible??false));
  document.getElementById('toggle-dailylevels').classList.toggle('active',isMain?config.showDailyLevels:(panel?.showDailyLevels??false));
}

function drawFrames(){
  if(clustersDirty){displayClusters=aggregateClusters(base5mClusters,config.displayTimeframe);extraPanels.forEach(p=>{p.displayClusters=aggregateClusters(base5mClusters,p.displayTimeframe);});clustersDirty=false;}
  if(!offscreenCtx||!chartOverlayCanvas)return;
  const cssWidth=chartOverlayCanvas.clientWidth,cssHeight=chartOverlayCanvas.clientHeight;
  const drawWidth=cssWidth-measuredPriceScaleWidth;
  const mB=chart.priceScale('right').options().scaleMargins.bottom,cbY=cssHeight*(1-mB);
  offscreenCtx.clearRect(0,0,cssWidth,cssHeight);offscreenCtx.save();offscreenCtx.beginPath();offscreenCtx.rect(0,0,drawWidth,cbY);offscreenCtx.clip();
  const ts=chart.timeScale(),bs=ts.options().barSpacing,vr=ts.getVisibleLogicalRange();
  if(!vr){ctxOverlay.clearRect(0,0,cssWidth,cssHeight);ctxOverlay.drawImage(offscreenCanvas,0,0);return;}
  const rts=getDynamicTickSize(config.baseTickSize,config.minCellHeight);
  document.getElementById('tick-display').innerText=`${rts}`;
  const totalW=bs*0.92,cw=totalW*config.candleWidthPercent,clw=totalW*config.clusterWidthPercent;
  const approxRange=60000,startP=Math.floor(currentPrice/config.gridSpacing)*config.gridSpacing-approxRange,endP=startP+approxRange*2;

  // Grid lines
  offscreenCtx.lineWidth=config.gridLineWidth;offscreenCtx.strokeStyle=hexToRgba(config.gridColor,config.gridOpacity);offscreenCtx.beginPath();
  for(let p=startP;p<=endP;p+=config.gridSpacing){if(Math.round(p)%5000===0)continue;const y=mainSeries.priceToCoordinate?.(p);if(y!==null&&y>=0&&y<=cbY){offscreenCtx.moveTo(0,y);offscreenCtx.lineTo(cssWidth-60,y);}}
  offscreenCtx.stroke();
  offscreenCtx.lineWidth=config.gridLineWidth*1.5;offscreenCtx.strokeStyle=hexToRgba('#f0b90b',config.gridOpacity);offscreenCtx.beginPath();
  for(let p=startP;p<=endP;p+=config.gridSpacing){if(Math.round(p)%5000!==0)continue;const y=mainSeries.priceToCoordinate?.(p);if(y!==null&&y>=0&&y<=cbY){offscreenCtx.moveTo(0,y);offscreenCtx.lineTo(cssWidth-60,y);}}
  offscreenCtx.stroke();

  drawTPO(cssWidth,cbY);drawVWAP(cssWidth,cbY);drawDailyLevels(cssWidth,cbY);

  // Candles
  displayCandles.forEach(candle=>{
    const x=ts.timeToCoordinate(candle.time);if(x===null||x<-100||x>cssWidth+100)return;
    const oY=mainSeries.priceToCoordinate(candle.open),cY=mainSeries.priceToCoordinate(candle.close);
    const hY=mainSeries.priceToCoordinate(candle.high),lY=mainSeries.priceToCoordinate(candle.low);
    if(oY===null||cY===null||hY===null||lY===null)return;
    const chY=Math.max(0,hY),clY=Math.min(cbY,lY),coY=Math.min(cbY,Math.max(0,oY)),ccY=Math.min(cbY,Math.max(0,cY));
    if(chY>cbY)return;
    const isUp=candle.close>=candle.open,color=hexToRgba(isUp?config.upColor:config.downColor,config.candleOpacity),sx=x-totalW/2;
    offscreenCtx.strokeStyle=color;offscreenCtx.lineWidth=config.wickThickness;offscreenCtx.beginPath();offscreenCtx.moveTo(sx+cw/2,chY);offscreenCtx.lineTo(sx+cw/2,clY);offscreenCtx.stroke();
    const bT=Math.min(coY,ccY),bH=Math.max(1,Math.abs(ccY-coY));
    if(config.seriesType==='candle'){
      offscreenCtx.fillStyle=color;offscreenCtx.fillRect(sx,bT,cw,bH);
      if(config.borderThickness>0){offscreenCtx.strokeStyle=color;offscreenCtx.lineWidth=config.borderThickness;offscreenCtx.strokeRect(sx,bT,cw,bH);}
    }else{
      offscreenCtx.strokeStyle=color;offscreenCtx.lineWidth=2;offscreenCtx.beginPath();
      offscreenCtx.moveTo(sx,coY);offscreenCtx.lineTo(sx+cw/2,coY);offscreenCtx.moveTo(sx+cw/2,ccY);offscreenCtx.lineTo(sx+cw,ccY);offscreenCtx.stroke();
    }
  });

  // Footprint clusters per candle
  if(!config.hideFootprints){
    const timestamps=Object.keys(displayClusters);
    for(let ti=0;ti<timestamps.length;ti++){
      const timestamp=timestamps[ti],tsSec=parseInt(timestamp),x=ts.timeToCoordinate(tsSec);
      if(x===null||x<-100||x>cssWidth+100)continue;
      const raw=displayClusters[timestamp];if(!raw||!Object.keys(raw).length)continue;
      const aggD={};
      Object.keys(raw).forEach(pk=>{const price=parseFloat(pk),data=raw[pk],ap=Math.floor(price/rts)*rts;if(!aggD[ap])aggD[ap]={buy:0,sell:0};aggD[ap].buy+=data.buy;aggD[ap].sell+=data.sell;});
      let pocK=null,pocT=-Infinity;Object.keys(aggD).forEach(pk=>{const t=aggD[pk].buy+aggD[pk].sell;if(t>pocT){pocT=t;pocK=pk;}});
      let mnP=Infinity,mxP=-Infinity;Object.keys(aggD).forEach(pk=>{const p=parseFloat(pk);if(p<mnP)mnP=p;if(p>mxP)mxP=p;});
      const yT=mainSeries.priceToCoordinate(mxP+rts),yB=mainSeries.priceToCoordinate(mnP);if(yT===null||yB===null)continue;
      const cyT=Math.max(0,Math.min(yT,cbY)),cyB=Math.max(0,Math.min(yB,cbY));if(cyT>=cbY)continue;
      const bxX=x-totalW/2+cw,bxH=Math.abs(cyB-cyT),bxY=Math.min(cyT,cyB);
      offscreenCtx.fillStyle=hexToRgba(config.panelColor,config.clusterBgOpacity);offscreenCtx.fillRect(bxX,bxY,clw,bxH);
      offscreenCtx.strokeStyle='#1a1f2e';offscreenCtx.lineWidth=config.cellBorderWidth;offscreenCtx.strokeRect(bxX,bxY,clw,bxH);
      offscreenCtx.font=`${config.cellFontWeight} ${config.cellFontSize}px ${config.statsFontFamily}`;offscreenCtx.textAlign='center';offscreenCtx.textBaseline='middle';
      Object.keys(aggD).forEach(pk=>{
        const pF=parseFloat(pk),data=aggD[pk];
        let cYT=mainSeries.priceToCoordinate(pF+rts),cYB=mainSeries.priceToCoordinate(pF);if(cYT===null||cYB===null)return;
        cYT=Math.max(0,Math.min(cYT,cbY));cYB=Math.max(0,Math.min(cYB,cbY));if(cYT>=cbY)return;
        const hC=Math.abs(cYB-cYT),dY=Math.min(cYT,cYB),delta=data.buy-data.sell,total=data.buy+data.sell;
        offscreenCtx.fillStyle=(config.clusterVolumeThreshold>0&&Math.abs(delta)<config.clusterVolumeThreshold)?'#485060':hexToRgba(delta>=0?config.upColor:config.downColor,calculateCellOpacity(total));
        offscreenCtx.fillRect(bxX,dY,clw,hC);
        if(String(pk)===String(pocK)){offscreenCtx.strokeStyle=config.pocColor;offscreenCtx.lineWidth=config.pocBorderWidth;offscreenCtx.strokeRect(bxX,dY,clw,hC);}
        if(hC>14){offscreenCtx.fillStyle='#fff';offscreenCtx.fillText(formatUSD(delta),bxX+clw/2,dY+hC/2);}
      });
    }
  }

  drawCumulativeCluster(cssWidth,cssHeight,cbY);

  // Delta bubbles
  if(!config.hideFootprints&&config.minBubbleVolume>0){
    const phase=(Date.now()%config.bubblePulseSpeed)/config.bubblePulseSpeed;
    const pulseOp=0.3+Math.sin(phase*Math.PI*2)*0.3;
    displayCandles.forEach(candle=>{
      const x=ts.timeToCoordinate(candle.time);if(x===null||x<-20||x>cssWidth+20)return;
      const b=displayClusters[String(Math.floor(candle.time))];if(!b)return;
      let tB=0,tS=0;Object.values(b).forEach(d=>{tB+=d.buy;tS+=d.sell;});
      const delta=tB-tS;const tfMultiplier=config.displayTimeframe/BASE_TIMEFRAME;if(Math.abs(delta)<config.minBubbleVolume*tfMultiplier)return;
      const isUp=candle.close>=candle.open,isDPos=delta>=0;
      const sy=isUp?mainSeries.priceToCoordinate(candle.high)-45:mainSeries.priceToCoordinate(candle.low)+40;
      if(sy<0||sy>cbY)return;
      const dy=isUp?sy-30:sy+30,bcX=x-totalW/2+totalW/2,dc=isDPos?config.upColor:config.downColor;
      offscreenCtx.save();offscreenCtx.globalAlpha=pulseOp;offscreenCtx.beginPath();offscreenCtx.arc(bcX,dy,config.bubbleOuterSize,0,Math.PI*2);offscreenCtx.fillStyle=dc;offscreenCtx.fill();offscreenCtx.restore();
      offscreenCtx.save();offscreenCtx.beginPath();offscreenCtx.arc(bcX,dy,config.bubbleInnerSize,0,Math.PI*2);offscreenCtx.fillStyle=dc;offscreenCtx.fill();offscreenCtx.restore();
    });
  }

  // Absorption dots & bar stats
  if(!config.hideFootprints&&displayCandles){
    offscreenCtx.textAlign='center';offscreenCtx.textBaseline='middle';
    const activeMgr2=_getActiveMgr(),bsActive=activeMgr2?.getIndicator('barstats')?.visible;
    displayCandles.forEach(candle=>{
      const x=ts.timeToCoordinate(candle.time);if(x===null||x<-50||x>cssWidth+50)return;
      const b=displayClusters[String(Math.floor(candle.time))];if(!b)return;
      let tB=0,tS=0;Object.values(b).forEach(d=>{tB+=d.buy;tS+=d.sell;});
      const total=tB+tS,delta=tB-tS;if(!total)return;
      const isUp=candle.close>=candle.open,oiInc=(candle.oiClose||0)>(candle.oiOpen||0);
      let vwN=0,vwD=0;Object.keys(b).forEach(pk=>{const pr=parseFloat(pk),vol=b[pk].buy+b[pk].sell;vwN+=pr*vol;vwD+=vol;});
      const cVWAP=vwD>0?vwN/vwD:candle.open;
      const isBullAbs=delta<=-config.absorptionThreshold&&candle.close>cVWAP&&oiInc;
      const isBearAbs=delta>=config.absorptionThreshold&&candle.close<cVWAP&&oiInc;
      if(isBullAbs||isBearAbs){
        const dy=isBullAbs?mainSeries.priceToCoordinate(candle.low)+25:mainSeries.priceToCoordinate(candle.high)-25;
        if(dy>0&&dy<cbY){offscreenCtx.save();offscreenCtx.shadowColor=config.absorptionColor;offscreenCtx.shadowBlur=config.absorptionGlow;offscreenCtx.fillStyle=config.absorptionColor;offscreenCtx.beginPath();offscreenCtx.arc(x,dy,config.absorptionDotSize,0,Math.PI*2);offscreenCtx.fill();offscreenCtx.shadowBlur=0;offscreenCtx.strokeStyle='#fff';offscreenCtx.lineWidth=1;offscreenCtx.stroke();offscreenCtx.restore();}
      }
      if(!bsActive){
        const sy=isUp?mainSeries.priceToCoordinate(candle.high)-45:mainSeries.priceToCoordinate(candle.low)+40;
        if(sy>=0&&sy<=cbY){
          const dc=delta>=0?config.upColor:config.downColor,bcX=x-totalW/2+totalW/2;
          offscreenCtx.font=`${config.statsFontWeight} ${config.statsFontSize}px ${config.statsFontFamily}`;offscreenCtx.fillStyle='#a6afd3';offscreenCtx.textAlign='center';
          offscreenCtx.fillText(`V:${formatUSD(total)}`,bcX,sy-8);
          const dv=formatUSD(delta),dW=offscreenCtx.measureText('D:').width,dvW=offscreenCtx.measureText(dv).width;
          offscreenCtx.textAlign='left';offscreenCtx.fillStyle='#a6afd3';offscreenCtx.fillText('D:',bcX-(dW+dvW)/2,sy+8);
          offscreenCtx.fillStyle=dc;offscreenCtx.fillText(dv,bcX-(dW+dvW)/2+dW,sy+8);offscreenCtx.textAlign='center';
        }
      }
    });
  }
  offscreenCtx.restore();
  if(indicatorManager)indicatorManager.drawAll(cssWidth);
  const tb=activeTimerBox;if(tb&&!tb.classList.contains('hidden')){tb.classList.add('hidden');tb.style.display='none';}
  updateCustomPriceLabel();updatePaneRight();
  ctxOverlay.clearRect(0,0,chartOverlayCanvas.width,chartOverlayCanvas.height);ctxOverlay.drawImage(offscreenCanvas,0,0);
}

// â”€â”€ Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function formatTime(s){if(s>=3600){const h=Math.floor(s/3600),m=Math.floor((s%3600)/60);return`${h}:${m.toString().padStart(2,'0')}`;}const m=Math.floor(s/60),sec=s%60;return`${m}:${sec.toString().padStart(2,'0')}`;}
function getIntervalString(tf){return{1:'1',3:'3',5:'5',15:'15',30:'30',60:'60',240:'240',D:'D'}[tf]||'5';}
function getOIIntervalString(tf){return{1:'5min',3:'5min',5:'5min',15:'15min',30:'30min',60:'1h',240:'4h',D:'1d'}[tf]||'5min';}
function getBarSeconds(tf){return tf==='D'?86400:tf*60;}
function getWSInterval(tf){return{1:'1',3:'3',5:'5',15:'15',30:'30',60:'60',240:'240',D:'D'}[tf]||'5';}
async function changeTimeframe(newTF){if(newTF<BASE_TIMEFRAME){alert(`Footprint information will not migrate to timeframes lower than ${BASE_TIMEFRAME}m`);return;}applyTimeframeChange(newTF);}
document.querySelectorAll('.timeframe-btn').forEach(btn=>{btn.addEventListener('click',()=>{const tf=btn.getAttribute('data-tf');changeTimeframe(tf==='D'?1440:parseInt(tf));});});

const ctxMenuMain=document.getElementById('ctx-menu-main'),settingsPanel=document.getElementById('settings-panel');
document.addEventListener('click',e=>{if(!e.target.closest('.context-menu')&&!e.target.closest('#settings-panel')&&!e.target.closest('#header-settings-btn'))ctxMenuMain.classList.add('hidden');});
document.getElementById('ctx-reset').onclick=()=>{
  if(selectedPanelId===0){chart.timeScale().scrollToRealTime();chart.priceScale('right').applyOptions({autoScale:true});}
  else{const p=extraPanels.find(p=>p.id===selectedPanelId);if(p){p.chart.timeScale().scrollToRealTime();p.chart.priceScale('right').applyOptions({autoScale:true});}}
  ctxMenuMain.classList.add('hidden');
};
const toggleSettings=()=>{settingsPanel.classList.toggle('-translate-x-full');settingsPanel.classList.toggle('translate-x-0');};
document.getElementById('header-settings-btn').onclick=toggleSettings;
document.getElementById('close-settings').onclick=toggleSettings;
document.getElementById('ctx-settings-trigger').onclick=toggleSettings;
document.getElementById('ctx-hide-footprints').onclick=()=>{
  if(selectedPanelId===0)config.hideFootprints=!config.hideFootprints;
  else{const p=extraPanels.find(p=>p.id===selectedPanelId);if(p)p.hideFootprints=!p.hideFootprints;}
  const active=selectedPanelId===0?config.hideFootprints:(extraPanels.find(p=>p.id===selectedPanelId)?.hideFootprints??false);
  const ind=document.getElementById('ctx-hide-footprints-indicator');ind.textContent=active?'â—':'â—‹';ind.style.color=active?'#3b82f6':'';
  ctxMenuMain.classList.add('hidden');scheduleDraw();
};
document.getElementById('cumulative-mode-select').onchange=e=>{config.cumulativeMode=e.target.value;scheduleDraw();};
document.getElementById('series-type-select').onchange=e=>{config.seriesType=e.target.value;mainSeries=createSeries(config.seriesType);mainSeries.setData(displayCandles);updateCandleAppearance();scheduleDraw();};
document.getElementById('up-candle-color').onchange=e=>{config.upColor=e.target.value;updateCandleAppearance();scheduleDraw();};
document.getElementById('down-candle-color').onchange=e=>{config.downColor=e.target.value;updateCandleAppearance();scheduleDraw();};
document.getElementById('candle-opacity').oninput=e=>{config.candleOpacity=e.target.value/100;document.getElementById('opacity-val').innerText=e.target.value+'%';updateCandleAppearance();scheduleDraw();};
document.getElementById('grid-spacing-input').onchange=e=>{config.gridSpacing=parseFloat(e.target.value);scheduleDraw();};
document.getElementById('grid-color-input').oninput=e=>{config.gridColor=e.target.value;scheduleDraw();};
document.getElementById('bubble-threshold-input').onchange=e=>{config.minBubbleVolume=parseFloat(e.target.value);scheduleDraw();};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Layout Manager
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function captureCurrentLayout(){
  const panels=[];
  const mainInds=[];indicatorManager.indicators.forEach((ind,id)=>{if(ind.visible)mainInds.push(id);});
  panels.push({id:0,timeframe:config.displayTimeframe,indicators:mainInds,hideFootprints:config.hideFootprints,showTPO:config.showTPO,vwapVisible:config.vwapVisible,showDailyLevels:config.showDailyLevels,visibleRange:chart.timeScale().getVisibleRange(),barSpacing:chart.timeScale().options().barSpacing});
  extraPanels.forEach(p=>{const pi=[];p.indicatorManager.indicators.forEach((ind,id)=>{if(ind.visible)pi.push(id);});panels.push({id:p.id,timeframe:p.displayTimeframe,indicators:pi,hideFootprints:p.hideFootprints,showTPO:p.showTPO,vwapVisible:p.vwapVisible,showDailyLevels:p.showDailyLevels,visibleRange:p.chart.timeScale().getVisibleRange(),barSpacing:p.chart.timeScale().options().barSpacing});});
  return{name:`Layout ${Date.now()}`,timestamp:Date.now(),schemaVersion:1,panels,glConfig:myLayout.saveLayout()};
}
function saveLayout(){
  const name=prompt('Name this layout:',`Layout ${new Date().toLocaleTimeString('ro-RO',{hour:'2-digit',minute:'2-digit'})}`);
  if(!name||!name.trim())return;
  const layout=captureCurrentLayout();layout.name=name.trim();
  let layouts=getSavedLayouts();layouts.push(layout);if(layouts.length>10)layouts=layouts.slice(-10);
  localStorage.setItem('btcChartLayouts',JSON.stringify(layouts));renderSavedLayouts();
}
function getSavedLayouts(){try{const r=localStorage.getItem('btcChartLayouts');return r?JSON.parse(r):[];}catch(e){return[];}}
function deleteLayout(timestamp){localStorage.setItem('btcChartLayouts',JSON.stringify(getSavedLayouts().filter(l=>l.timestamp!==timestamp)));renderSavedLayouts();}

function applyLayout(layout){
  if(!layout.glConfig){alert('This layout format is from an older version and is incompatible with the new Layout Engine.');return;}
  const CURRENT_SCHEMA=1;
  if(layout.schemaVersion===undefined)console.warn('Loading a layout saved before schema versioning. It may behave unexpectedly.');
  else if(layout.schemaVersion>CURRENT_SCHEMA){alert(`Layout saved with newer schema v${layout.schemaVersion}, current is v${CURRENT_SCHEMA}.`);return;}

  function fixGLSizes(obj){
    if(!obj||typeof obj!=='object')return;
    if(typeof obj.size==='number')obj.size=obj.size+'%';
    if(typeof obj.width==='number')obj.width=obj.width+'%';
    if(typeof obj.height==='number')obj.height=obj.height+'%';
    ['minItemHeight','minItemWidth','minHeight','minWidth','defaultMinItemHeight','defaultMinItemWidth'].forEach(prop=>{
      if(obj[prop]==null)delete obj[prop];else if(typeof obj[prop]==='number')obj[prop]=obj[prop]+'px';
    });
    Object.values(obj).forEach(val=>{if(val&&typeof val==='object')fixGLSizes(val);});
  }
  fixGLSizes(layout.glConfig);

  [...extraPanels].forEach(p=>{if(p.rafId)cancelAnimationFrame(p.rafId);p.chart.remove();});
  extraPanels.length=0;extraPanelCounter=0;
  ['oi','cvd','barstats'].forEach(id=>{const ind=indicatorManager.getIndicator(id);if(ind&&ind.visible)indicatorManager.removeIndicator(id);});

  myLayout.loadLayout(layout.glConfig);

  const mainL=layout.panels.find(p=>p.id===0);
  if(mainL){
    applyTimeframeChange(mainL.timeframe);
    mainL.indicators.forEach(id=>{if(id==='oi')indicatorManager.addIndicator(new OIIndicator());else if(id==='cvd')indicatorManager.addIndicator(new CVDIndicator());else if(id==='barstats')indicatorManager.addIndicator(new BarStatsIndicator());});
    config.hideFootprints=mainL.hideFootprints;config.showTPO=mainL.showTPO;config.vwapVisible=mainL.vwapVisible;config.showDailyLevels=mainL.showDailyLevels;tpoCacheKey='';
    if(mainL.barSpacing)chart.timeScale().applyOptions({barSpacing:mainL.barSpacing});
    if(mainL.visibleRange)setTimeout(()=>{try{chart.timeScale().setVisibleRange(mainL.visibleRange);}catch(e){}},50);
  }
  const extraLayouts=layout.panels.filter(p=>p.id!==0);
  extraPanels.forEach((np,i)=>{
    const sp=extraLayouts[i];if(!sp)return;
    np.displayTimeframe=sp.timeframe;np.displayCandles=aggregateCandles(base5mCandles,sp.timeframe);np.displayClusters=aggregateClusters(base5mClusters,sp.timeframe);np.mainSeries.setData(np.displayCandles);
    sp.indicators.forEach(id=>{if(id==='oi')np.indicatorManager.addIndicator(new OIIndicator());else if(id==='cvd')np.indicatorManager.addIndicator(new CVDIndicator());else if(id==='barstats')np.indicatorManager.addIndicator(new BarStatsIndicator());});
    np.hideFootprints=sp.hideFootprints;np.showTPO=sp.showTPO;np.vwapVisible=sp.vwapVisible;np.showDailyLevels=sp.showDailyLevels;np.tpoCacheKey='';
    if(sp.barSpacing)np.chart.timeScale().applyOptions({barSpacing:sp.barSpacing});
    if(sp.visibleRange)setTimeout(()=>{try{np.chart.timeScale().setVisibleRange(sp.visibleRange);}catch(e){}},50);
    syncPanelTFBar(np,sp.timeframe);schedulePanelDraw(np);
  });
  selectedPanelId=0;syncHeaderButtons();scheduleDraw();closeLayoutsDropdown();
}

function renderSavedLayouts(){
  const container=document.getElementById('saved-layouts-list'),layouts=getSavedLayouts();
  if(!layouts.length){container.innerHTML='<div class="px-4 py-2 text-[10px] text-gray-600 font-mono italic">No saved layouts yet</div>';return;}
  container.innerHTML='';
  [...layouts].reverse().forEach(layout=>{
    const row=document.createElement('div');row.className='group flex items-center justify-between px-4 py-2 hover:bg-blue-600/10 cursor-pointer transition-colors';
    const n=layout.panels.length,t=new Date(layout.timestamp).toLocaleString('ro-RO',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'});
    row.innerHTML=`<div class="flex-1 min-w-0"><div class="text-[11px] font-mono text-gray-300 group-hover:text-blue-400 transition-colors truncate">${layout.name}</div><div class="text-[9px] text-gray-600 font-mono mt-0.5">${n} chart${n>1?'s':''} Â· ${t}</div></div><button class="delete-layout-btn ml-2 opacity-0 group-hover:opacity-100 transition-opacity text-gray-600 hover:text-red-400 text-xs p-1 rounded" data-ts="${layout.timestamp}">âœ•</button>`;
    row.querySelector('.flex-1').addEventListener('click',()=>applyLayout(layout));
    row.querySelector('.delete-layout-btn').addEventListener('click',e=>{e.stopPropagation();if(confirm(`Delete "${layout.name}"?`))deleteLayout(layout.timestamp);});
    container.appendChild(row);
  });
}
function syncPanelTFBar(panel,timeframe){
  const tfBar=panel.wrapperEl.querySelector('.panel-tf-bar');if(!tfBar)return;
  const map={'5m':5,'15m':15,'30m':30,'1h':60,'4h':240,'1D':1440};
  tfBar.querySelectorAll('.timeframe-btn').forEach(btn=>{btn.classList.toggle('active',map[btn.textContent.trim()]===timeframe);});
}
function closeLayoutsDropdown(){const dd=document.getElementById('layouts-dropdown');dd.classList.remove('open');setTimeout(()=>dd.classList.add('hidden'),200);}

document.getElementById('layouts-btn').addEventListener('click',e=>{
  e.stopPropagation();const dd=document.getElementById('layouts-dropdown'),isOpen=dd.classList.contains('open');
  if(isOpen)closeLayoutsDropdown();else{dd.classList.remove('hidden');requestAnimationFrame(()=>dd.classList.add('open'));renderSavedLayouts();}
});
document.getElementById('save-layout-btn').addEventListener('click',e=>{e.stopPropagation();saveLayout();});
document.addEventListener('click',e=>{if(!e.target.closest('#layouts-wrapper'))closeLayoutsDropdown();});

// â”€â”€ Boot Sequence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchOpenInterest(){
  try{
    const r=await fetch(`https://api.bybit.com/v5/market/open-interest?category=inverse&symbol=BTCUSD&intervalTime=${getOIIntervalString(BASE_TIMEFRAME)}&limit=200`);
    const d=await r.json();
    if(d.result?.list){
      const oiMap={},bs=getBarSeconds(BASE_TIMEFRAME);
      d.result.list.forEach(item=>{const ts=parseInt(item.timestamp)/1000;oiMap[Math.floor(ts/bs)*bs]=parseFloat(item.openInterest);});
      let prevOI=0;const fts=Object.keys(oiMap).sort()[0];if(fts)prevOI=oiMap[fts]/(base5mCandles.find(c=>c.time>=fts)?.close||1);
      base5mCandles.forEach(c=>{const raw=oiMap[c.time];if(raw){const oi=raw/c.close;if(!prevOI)prevOI=oi;c.oiOpen=prevOI;c.oiClose=oi;c.oiHigh=Math.max(prevOI,oi);c.oiLow=Math.min(prevOI,oi);prevOI=oi;}else{c.oiOpen=prevOI;c.oiClose=prevOI;c.oiHigh=prevOI;c.oiLow=prevOI;}});
      displayCandles=base5mCandles.slice();
      if(prevOI>0)document.getElementById('oi-display').innerText=prevOI.toFixed(2);
    }
  }catch(e){console.error('OI Fetch Error',e);}
}

function startWebSockets(){
  const wsInt=getWSInterval(BASE_TIMEFRAME);
  ws=new WebSocket('wss://stream.bybit.com/v5/public/inverse');
  ws.onopen=()=>ws.send(JSON.stringify({op:'subscribe',args:[`kline.${wsInt}.BTCUSD`,'publicTrade.BTCUSD','tickers.BTCUSD']}));
  ws.onclose=()=>{console.warn('WS disconnected, reconnecting in 3s...');setTimeout(startWebSockets,3000);};
  ws.onerror=e=>{console.error('WS error',e);ws.close();};
  ws.onmessage=event=>{
    let msg;try{msg=JSON.parse(event.data);}catch(e){console.warn('WS parse error:',e);return;}
    if(!msg.data)return;
    try{
      if(msg.topic?.includes('tickers')&&msg.data.openInterest){
        const rawOI=parseFloat(msg.data.openInterest),lc=base5mCandles[base5mCandles.length-1];
        if(lc&&currentPrice>0){
          const oiBTC=rawOI/currentPrice;document.getElementById('oi-display').innerText=oiBTC.toFixed(2);
          if(!lc.oiOpen)lc.oiOpen=base5mCandles.length>1?base5mCandles[base5mCandles.length-2].oiClose:oiBTC;
          lc.oiClose=oiBTC;lc.oiHigh=Math.max(lc.oiHigh||-Infinity,oiBTC);lc.oiLow=Math.min(lc.oiLow||Infinity,oiBTC);
          displayCandles=aggregateCandles(base5mCandles,config.displayTimeframe);scheduleDraw();
        }
      }
      if(msg.topic?.includes('kline')){
        const k=msg.data[0],ts=parseInt(k.start)/1000;
        if(ts>lastBarTime){
          const closingOI=base5mCandles[base5mCandles.length-1]?.oiClose||0;
          base5mClusters[String(ts)]={};lastBarTime=ts;
          upsertCandle(ts,parseFloat(k.open),parseFloat(k.high),parseFloat(k.low),parseFloat(k.close),parseFloat(k.volume||0));
          const nc=base5mCandles[base5mCandles.length-1];nc.oiOpen=closingOI;nc.oiClose=closingOI;nc.oiHigh=closingOI;nc.oiLow=closingOI;tpoCacheKey='';
        }else upsertCandle(ts,parseFloat(k.open),parseFloat(k.high),parseFloat(k.low),parseFloat(k.close),parseFloat(k.volume||0));
        displayCandles=aggregateCandles(base5mCandles,config.displayTimeframe);displayClusters=aggregateClusters(base5mClusters,config.displayTimeframe);
        mainSeries.update(displayCandles[displayCandles.length-1]);updateCandleAppearance();
        extraPanels.forEach(p=>{p.displayCandles=aggregateCandles(base5mCandles,p.displayTimeframe);p.displayClusters=aggregateClusters(base5mClusters,p.displayTimeframe);const lc=p.displayCandles[p.displayCandles.length-1];if(lc){p.mainSeries.update(lc);const lColor=(lc.close>=lc.open)?config.upColor:config.downColor;p.mainSeries.applyOptions({priceLineColor:lColor});}});
        scheduleDraw();
      }
      if(msg.topic?.includes('publicTrade')){
        msg.data.forEach(trade=>{
          const price=parseFloat(trade.p);currentPrice=price;
          const valUsd=parseFloat(trade.v),bucket=Math.floor(price/config.baseTickSize)*config.baseTickSize;
          const tk=String(lastBarTime),bk=String(bucket);
          if(!base5mClusters[tk])base5mClusters[tk]={};if(!base5mClusters[tk][bk])base5mClusters[tk][bk]={buy:0,sell:0};
          if(trade.S==='Buy')base5mClusters[tk][bk].buy+=valUsd;else base5mClusters[tk][bk].sell+=valUsd;
          clustersDirty=true;
          const lb=base5mCandles[base5mCandles.length-1];
          if(lb){lb.close=price;if(price>lb.high)lb.high=price;if(price<lb.low)lb.low=price;
            const ld=displayCandles[displayCandles.length-1];if(ld){ld.close=price;if(price>ld.high)ld.high=price;if(price<ld.low)ld.low=price;mainSeries.update(ld);}
          }
          document.getElementById('price').innerText=price.toLocaleString();scheduleDraw();
        });
      }
    }catch(e){console.error('WS message error:',e,event.data);}
  };
}

document.getElementById('add-chart-btn').addEventListener('click',()=>{
  if(!myLayout)return;
  const pc={type:'component',componentType:'chartComponent',componentState:{isMain:false},title:`BTCUSD ${extraPanelCounter+1}`};
  try{if(myLayout.rootItem&&myLayout.rootItem.contentItems.length>0)myLayout.rootItem.contentItems[0].addItem(pc);else myLayout.addItem(pc);}
  catch(e){console.error('Failed to add chart panel:',e);}
});

async function init(){
  const glModule=await import('https://cdn.jsdelivr.net/npm/golden-layout@2.6.0/+esm');
  window.goldenLayout=glModule;
  initGoldenLayout();
  setTimeout(async()=>{
    if(!chart||!mainSeries){console.error('Golden Layout failed to map Panel 0 correctly.');return;}
    chart.timeScale().subscribeVisibleLogicalRangeChange(()=>{if(typeof scheduleDraw==='function')scheduleDraw();});
    chart.subscribeCrosshairMove(param=>{crosshairPos=param.point||null;scheduleDraw();});
    if(indicatorManager)indicatorManager.addIndicator(new OIIndicator());
    syncHeaderButtons();
    try{
      const r=await fetch(`https://api.bybit.com/v5/market/kline?category=inverse&symbol=BTCUSD&interval=${getIntervalString(BASE_TIMEFRAME)}&limit=1000`);
      const data=await r.json();
      if(data.result?.list){
        base5mCandles=data.result.list.map(d=>({time:parseInt(d[0])/1000,open:parseFloat(d[1]),high:parseFloat(d[2]),low:parseFloat(d[3]),close:parseFloat(d[4]),volume:parseFloat(d[5]),oiOpen:0,oiHigh:0,oiLow:0,oiClose:0})).sort((a,b)=>a.time-b.time);
        displayCandles=base5mCandles.slice();displayClusters=aggregateClusters(base5mClusters,config.displayTimeframe);
        mainSeries.setData(displayCandles);lastBarTime=base5mCandles[base5mCandles.length-1].time;currentPrice=base5mCandles[base5mCandles.length-1].close;tpoCacheKey='';
        await fetchOpenInterest();chart.timeScale().fitContent();updateCandleAppearance();
      }
      startWebSockets();setInterval(()=>{needsRedraw=true;scheduleDraw();},config.drawDelay);
    }catch(e){console.error(e);}
  },50);
}
init();
</script>
</body>
</html>
